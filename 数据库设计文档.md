# NIS3351 智能家居监控系统数据库设计文档

**项目名称**: NIS3351 Smart Home Monitoring System
**数据库系统**: openGauss / SQLite
**设计日期**: 2024年
**设计者**: [您的姓名]

---

## 目录

1. [需求分析](#1-需求分析)
2. [概念结构设计](#2-概念结构设计)
3. [逻辑结构设计](#3-逻辑结构设计)
4. [物理设计](#4-物理设计)
5. [数据库实施](#5-数据库实施)
6. [运行与维护](#6-运行与维护)

---

## 1. 需求分析

### 1.1 系统概述

NIS3351 是一个基于物联网技术的智能家居监控系统，采用 Flask + MQTT + openGauss/SQLite 架构，实现对家居设备的实时监控和智能控制。

### 1.2 业务需求

#### 1.2.1 功能需求

**（1）环境监测功能**
- 实时采集各房间温度和湿度数据
- 支持多个传感器设备（room1, room2等）
- 提供历史数据查询和统计分析
- 数据采集频率：每分钟一次

**（2）智能门锁管理**
- 支持三种解锁方式：PIN码、指纹、人脸识别
- 记录所有开锁/上锁操作的审计日志
- 实时监控门锁状态（上锁/解锁）
- 监控门锁电池电量
- 支持自动上锁配置（时间延迟设定）
- 用户权限管理（添加/删除授权用户）
- 全局PIN码管理

**（3）空调智能控制**
- 根据温湿度数据自动调节空调
- 支持多种工作模式：制冷、制热、送风、除湿、自动
- 记录空调操作历史（开关机、温度调整、模式切换）
- 支持远程控制和定时任务
- 风速调节：自动、低速、中速、高速

**（4）智能照明系统**
- 控制各房间灯具开关和亮度
- 支持自动调光模式（根据环境亮度）
- 色温调节（2700K-6500K）
- 记录灯具操作历史

**（5）烟雾报警系统**
- 实时监测烟雾浓度（0-100级别）
- 超过阈值自动触发报警
- 支持测试模式
- 三档灵敏度调节（低/中/高）
- 电池电量监控
- 报警事件记录和确认机制

#### 1.2.2 数据需求

**核心数据对象：**

| 数据对象 | 关键属性 | 数据量估算 |
|---------|---------|-----------|
| 温湿度记录 | 设备ID、温度、湿度、时间戳 | ~43,200条/月/设备 |
| 门锁状态 | 锁ID、状态、解锁方式、操作人、电量 | 1条/锁 |
| 门锁事件 | 锁ID、事件类型、方式、操作人、详情 | ~50-100条/月 |
| 授权用户 | 用户名、密码哈希、PIN码、指纹、人脸图像 | ~5-10人 |
| 空调状态 | 空调ID、电源、模式、目标温度、当前温湿度 | 1条/空调 |
| 空调事件 | 空调ID、事件类型、旧值、新值 | ~100-200条/月 |
| 灯具状态 | 灯ID、电源、亮度、自动模式、色温 | 1条/灯具 |
| 烟雾报警器状态 | 报警器ID、位置、烟雾浓度、报警状态、灵敏度 | 1条/报警器 |
| 烟雾报警事件 | 报警器ID、事件类型、烟雾浓度、详情 | ~10-50条/月 |

#### 1.2.3 性能需求

- **响应时间**：门锁控制 < 1秒，空调控制 < 2秒
- **并发支持**：同时支持10个设备数据上报
- **数据保留**：温湿度数据保留3个月，事件日志保留1年
- **查询性能**：历史数据查询 < 3秒（1000条记录）

#### 1.2.4 安全性需求

- 用户密码采用bcrypt哈希存储
- 门锁操作全程审计日志记录
- PIN码加密存储
- 防止暴力破解（登录失败次数限制）

### 1.3 数据流图

```
传感器设备 ──(MQTT)──> 后端服务 ──> 数据库
    ↓                      ↓           ↓
温湿度数据           业务逻辑处理    持久化存储
                           ↓
    ↑                  控制指令
    └────(MQTT)────── 空调/门锁/灯具
```

### 1.4 数据字典（核心字段）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| device_id | VARCHAR(50) | NOT NULL | 设备唯一标识 |
| temperature | FLOAT | NOT NULL | 温度值（摄氏度） |
| humidity | FLOAT | NOT NULL | 湿度值（百分比） |
| locked | BOOLEAN | NOT NULL | 门锁状态（TRUE=上锁） |
| method | VARCHAR(20) | - | 解锁方式（PINCODE/FINGERPRINT/FACE） |
| event_type | VARCHAR(32) | NOT NULL | 事件类型 |
| power | BOOLEAN | DEFAULT false | 设备电源状态 |
| target_temp | FLOAT | DEFAULT 26.0 | 目标温度 |
| smoke_level | FLOAT | DEFAULT 0.0 | 烟雾浓度（0-100） |
| sensitivity | VARCHAR(20) | DEFAULT 'medium' | 灵敏度（low/medium/high） |

---

## 2. 概念结构设计

### 2.1 实体识别

通过需求分析，识别出以下核心实体：

1. **温湿度传感器设备** (TemperatureSensor)
2. **智能门锁** (SmartLock)
3. **授权用户** (LockUser)
4. **自动锁配置** (AutoLockConfig)
5. **智能空调** (AirConditioner)
6. **智能灯具** (SmartLight)
7. **烟雾报警器** (SmokeAlarm)
8. **传感器数据记录** (SensorData)
9. **门锁事件** (LockEvent)
10. **空调事件** (ACEvent)
11. **灯具事件** (LightEvent)
12. **烟雾报警事件** (SmokeAlarmEvent)

### 2.2 实体属性

#### 实体1：温湿度传感器数据 (temperature_humidity_data)

| 属性名 | 数据类型 | 说明 |
|-------|---------|------|
| id | 整型（主键） | 记录唯一标识 |
| device_id | 字符串 | 设备ID |
| temperature | 浮点型 | 温度值 |
| humidity | 浮点型 | 湿度值 |
| timestamp | 时间戳 | 采集时间 |

#### 实体2：智能门锁状态 (lock_state)

| 属性名 | 数据类型 | 说明 |
|-------|---------|------|
| lock_id | 字符串（主键） | 门锁唯一标识 |
| locked | 布尔型 | 上锁状态 |
| method | 字符串 | 最后操作方式 |
| actor | 字符串 | 最后操作人 |
| battery | 整型 | 电池电量 |
| updated_at | 时间戳 | 更新时间 |

#### 实体3：授权用户 (lock_users)

| 属性名 | 数据类型 | 说明 |
|-------|---------|------|
| id | 整型（主键） | 用户ID |
| username | 字符串（唯一） | 用户名 |
| password_hash | 字符串 | 密码哈希 |
| pincode | 字符串 | PIN码 |
| face_image_path | 字符串 | 人脸图像路径 |
| fingerprint_data | 文本 | 指纹数据 |
| created_at | 时间戳 | 创建时间 |
| updated_at | 时间戳 | 更新时间 |

#### 实体4：自动锁配置 (lock_auto_config)

| 属性名 | 数据类型 | 说明 |
|-------|---------|------|
| lock_id | 字符串（主键） | 门锁ID |
| auto_lock_enabled | 布尔型 | 是否启用自动锁 |
| auto_lock_delay | 整型 | 自动锁延迟（秒） |
| updated_at | 时间戳 | 更新时间 |

#### 实体5：智能空调状态 (ac_state)

| 属性名 | 数据类型 | 说明 |
|-------|---------|------|
| ac_id | 字符串（主键） | 空调ID |
| device_id | 字符串 | 关联房间设备ID |
| power | 布尔型 | 电源状态 |
| mode | 字符串 | 工作模式 |
| target_temp | 浮点型 | 目标温度 |
| current_temp | 浮点型 | 当前温度 |
| current_humidity | 浮点型 | 当前湿度 |
| fan_speed | 字符串 | 风速 |
| updated_at | 时间戳 | 更新时间 |

#### 实体6：智能灯具状态 (lighting_state)

| 属性名 | 数据类型 | 说明 |
|-------|---------|------|
| light_id | 字符串（主键） | 灯具ID |
| device_id | 字符串 | 关联房间设备ID |
| power | 布尔型 | 电源状态 |
| brightness | 整型 | 亮度（0-100） |
| auto_mode | 布尔型 | 自动调光模式 |
| room_brightness | 浮点型 | 房间亮度 |
| color_temp | 整型 | 色温（K） |
| updated_at | 时间戳 | 更新时间 |

#### 实体7：烟雾报警器状态 (smoke_alarm_state)

| 属性名 | 数据类型 | 说明 |
|-------|---------|------|
| alarm_id | 字符串（主键） | 报警器ID |
| location | 字符串 | 安装位置 |
| smoke_level | 浮点型 | 烟雾浓度 |
| alarm_active | 布尔型 | 报警状态 |
| battery | 整型 | 电池电量 |
| test_mode | 布尔型 | 测试模式 |
| sensitivity | 字符串 | 灵敏度 |
| updated_at | 时间戳 | 更新时间 |

#### 事件实体（历史记录）

**门锁事件 (lock_events)**：id, lock_id, event_type, method, actor, detail, timestamp

**空调事件 (ac_events)**：id, ac_id, event_type, old_value, new_value, detail, timestamp

**灯具事件 (lighting_events)**：id, light_id, event_type, old_value, new_value, detail, timestamp

**烟雾报警事件 (smoke_alarm_events)**：id, alarm_id, event_type, smoke_level, detail, timestamp

### 2.3 实体间联系

#### E-R 图说明

```
┌─────────────────┐
│TemperatureSensor│ 1
└────────┬────────┘
         │ 产生
         │ N
         ▼
┌─────────────────┐
│  SensorData     │
└─────────────────┘

┌─────────────────┐           ┌─────────────────┐
│   SmartLock     │ 1       1 │ AutoLockConfig  │
└────────┬────────┘───────────└─────────────────┘
         │
         │ 产生
         │ N
         ▼
┌─────────────────┐
│   LockEvent     │
└─────────────────┘
         ▲
         │ 记录操作
         │ N
         │
┌────────┴────────┐
│    LockUser     │ N (用户可进行多次操作)
└─────────────────┘

┌─────────────────┐
│ AirConditioner  │ 1
└────────┬────────┘
         │ 产生
         │ N
         ▼
┌─────────────────┐
│    ACEvent      │
└─────────────────┘

┌─────────────────┐
│   SmartLight    │ 1
└────────┬────────┘
         │ 产生
         │ N
         ▼
┌─────────────────┐
│  LightEvent     │
└─────────────────┘

┌─────────────────┐
│   SmokeAlarm    │ 1
└────────┬────────┘
         │ 产生
         │ N
         ▼
┌─────────────────┐
│SmokeAlarmEvent  │
└─────────────────┘
```

**联系说明：**

1. **设备与数据** (1:N)：一个传感器设备产生多条数据记录
2. **门锁与配置** (1:1)：一个门锁对应一个自动锁配置
3. **门锁与事件** (1:N)：一个门锁产生多个事件记录
4. **用户与事件** (N:N)：用户执行多次操作，每次操作记录为一个事件
5. **空调与事件** (1:N)：一个空调产生多个控制事件
6. **灯具与事件** (1:N)：一个灯具产生多个操作事件
7. **报警器与事件** (1:N)：一个报警器产生多个报警事件

### 2.4 完整E-R图（总图）

```
                    ┌──────────────────┐
                    │  Smart Home      │
                    │  System          │
                    └────────┬─────────┘
                             │
         ┌───────────────────┼───────────────────┬──────────────┐
         │                   │                   │              │
         ▼                   ▼                   ▼              ▼
  ┌────────────┐      ┌────────────┐     ┌────────────┐ ┌─────────────┐
  │Environment │      │  Security  │     │  Climate   │ │   Safety    │
  │Monitoring  │      │  Control   │     │  Control   │ │   System    │
  └──────┬─────┘      └──────┬─────┘     └──────┬─────┘ └──────┬──────┘
         │                   │                   │              │
    ┌────┴────┐         ┌────┴────┐         ┌────┴────┐    ┌────┴─────┐
    ▼         ▼         ▼         ▼         ▼         ▼    ▼          ▼
  Sensor   Sensor    Lock    Lock      AC       AC    Light  Smoke    Smoke
  Device    Data    State   Event    State   Event   State   Alarm   Event
                      ▲                                      State
                      │
                  ┌───┴────┐
                  │  Lock  │
                  │  User  │
                  └────────┘
```

---

## 3. 逻辑结构设计

### 3.1 E-R图到关系模式转换

#### 3.1.1 实体转换规则

每个实体转换为一个关系模式，实体的属性转换为关系的属性，实体的主键转换为关系的主键。

**转换结果：**

1. **temperature_humidity_data**(<u>id</u>, device_id, temperature, humidity, timestamp)
2. **lock_state**(<u>lock_id</u>, locked, method, actor, battery, updated_at)
3. **lock_events**(<u>id</u>, lock_id, event_type, method, actor, detail, timestamp)
4. **lock_users**(<u>id</u>, username, password_hash, pincode, face_image_path, fingerprint_data, created_at, updated_at)
5. **lock_auto_config**(<u>lock_id</u>, auto_lock_enabled, auto_lock_delay, updated_at)
6. **ac_state**(<u>ac_id</u>, device_id, power, mode, target_temp, current_temp, current_humidity, fan_speed, updated_at)
7. **ac_events**(<u>id</u>, ac_id, event_type, old_value, new_value, detail, timestamp)
8. **lighting_state**(<u>light_id</u>, device_id, power, brightness, auto_mode, room_brightness, color_temp, updated_at)
9. **lighting_events**(<u>id</u>, light_id, event_type, old_value, new_value, detail, timestamp)
10. **smoke_alarm_state**(<u>alarm_id</u>, location, smoke_level, alarm_active, battery, test_mode, sensitivity, updated_at)
11. **smoke_alarm_events**(<u>id</u>, alarm_id, event_type, smoke_level, detail, timestamp)

#### 3.1.2 联系转换规则

**1对N联系**：在N端实体对应的关系中加入1端实体的主键作为外键。

- lock_events.lock_id → lock_state.lock_id
- ac_events.ac_id → ac_state.ac_id
- lighting_events.light_id → lighting_state.light_id
- smoke_alarm_events.alarm_id → smoke_alarm_state.alarm_id
- lock_auto_config.lock_id → lock_state.lock_id

### 3.2 关系模式规范化

#### 3.2.1 第一范式（1NF）检查

所有关系模式均满足1NF要求：
- 每个属性都是不可再分的原子值
- 不存在重复组

**示例**：lock_users表中，face_image_path存储路径字符串（原子值），fingerprint_data存储JSON格式（作为整体处理）。

#### 3.2.2 第二范式（2NF）检查

检查是否存在非主属性对主键的部分依赖。

**temperature_humidity_data**:
- 主键：id
- 函数依赖：id → (device_id, temperature, humidity, timestamp)
- 结论：满足2NF（单一主键，不存在部分依赖）

**lock_events**:
- 主键：id
- 函数依赖：id → (lock_id, event_type, method, actor, detail, timestamp)
- 结论：满足2NF

**所有表均满足2NF要求**。

#### 3.2.3 第三范式（3NF）检查

检查是否存在非主属性对主键的传递依赖。

**ac_state表分析**:
- 主键：ac_id
- 直接依赖：ac_id → (device_id, power, mode, target_temp, current_temp, current_humidity, fan_speed, updated_at)
- current_temp 和 current_humidity 实际来自 temperature_humidity_data 表，但作为缓存字段存储以提高查询性能
- 这是**冗余设计**，用于避免频繁关联查询

**设计权衡**：
- 理论上应该通过device_id关联temperature_humidity_data表获取当前温湿度
- 实际保留冗余以优化查询性能（智能控制场景需要频繁读取）
- 通过应用层逻辑保证数据一致性

#### 3.2.4 优化调整

**性能优化冗余**：
1. ac_state.current_temp / current_humidity（来自传感器数据，缓存以提高响应速度）
2. lock_state.method / actor（记录最后一次操作信息，避免查询事件表）

**反规范化决策**：
- 优先保证查询性能
- 通过MQTT消息处理逻辑同步更新冗余字段
- 事件表保留完整历史记录用于审计

### 3.3 外键约束定义

由于系统使用openGauss和SQLite双后端，外键约束通过应用层逻辑维护（部分数据库不强制外键）。

**逻辑外键关系**：

```sql
-- 门锁事件关联门锁状态
lock_events.lock_id → lock_state.lock_id

-- 自动锁配置关联门锁
lock_auto_config.lock_id → lock_state.lock_id

-- 空调事件关联空调状态
ac_events.ac_id → ac_state.ac_id

-- 灯具事件关联灯具状态
lighting_events.light_id → lighting_state.light_id

-- 烟雾报警事件关联报警器状态
smoke_alarm_events.alarm_id → smoke_alarm_state.alarm_id
```

### 3.4 用户视图设计

#### 视图1：设备监控总览

```sql
CREATE VIEW v_device_monitor AS
SELECT
    'sensor' AS device_type,
    device_id,
    temperature AS value1,
    humidity AS value2,
    timestamp AS last_update
FROM temperature_humidity_data
WHERE timestamp = (SELECT MAX(timestamp) FROM temperature_humidity_data)
UNION ALL
SELECT
    'lock' AS device_type,
    lock_id AS device_id,
    CASE WHEN locked THEN 1 ELSE 0 END AS value1,
    battery AS value2,
    updated_at AS last_update
FROM lock_state;
```

#### 视图2：今日事件汇总

```sql
CREATE VIEW v_today_events AS
SELECT
    'LOCK' AS source,
    lock_id AS device_id,
    event_type,
    actor,
    timestamp
FROM lock_events
WHERE DATE(timestamp) = CURRENT_DATE
UNION ALL
SELECT
    'AC' AS source,
    ac_id AS device_id,
    event_type,
    NULL AS actor,
    timestamp
FROM ac_events
WHERE DATE(timestamp) = CURRENT_DATE
UNION ALL
SELECT
    'SMOKE' AS source,
    alarm_id AS device_id,
    event_type,
    NULL AS actor,
    timestamp
FROM smoke_alarm_events
WHERE DATE(timestamp) = CURRENT_DATE
ORDER BY timestamp DESC;
```

#### 视图3：空调运行状态

```sql
CREATE VIEW v_ac_status AS
SELECT
    a.ac_id,
    a.device_id,
    a.power,
    a.mode,
    a.target_temp,
    t.temperature AS current_temp,
    t.humidity AS current_humidity,
    a.updated_at
FROM ac_state a
LEFT JOIN (
    SELECT device_id, temperature, humidity
    FROM temperature_humidity_data
    WHERE timestamp = (SELECT MAX(timestamp) FROM temperature_humidity_data)
) t ON a.device_id = t.device_id;
```

---

## 4. 物理设计

### 4.1 存储结构设计

#### 4.1.1 数据库选型

**开发环境**: SQLite 3.x
- 零配置，文件型数据库
- 适合单机开发和测试
- 自动事务管理

**生产环境**: openGauss 5.x
- 高性能分布式数据库
- 支持Kunpeng架构优化
- 企业级高可用特性

#### 4.1.2 表空间规划

**openGauss表空间设计**:

```sql
-- 系统数据表空间（状态表）
CREATE TABLESPACE ts_state LOCATION '/data/opengauss/state';

-- 历史数据表空间（事件表、传感器数据）
CREATE TABLESPACE ts_history LOCATION '/data/opengauss/history';

-- 分配表到表空间
ALTER TABLE lock_state SET TABLESPACE ts_state;
ALTER TABLE ac_state SET TABLESPACE ts_state;
ALTER TABLE temperature_humidity_data SET TABLESPACE ts_history;
ALTER TABLE lock_events SET TABLESPACE ts_history;
```

### 4.2 索引设计

#### 4.2.1 B+树索引

**温湿度数据表**:
```sql
-- 主键索引（自动创建）
PRIMARY KEY (id)

-- 时间范围查询索引（降序优化最新数据查询）
CREATE INDEX idx_temp_hum_timestamp
ON temperature_humidity_data(timestamp DESC);

-- 设备筛选索引
CREATE INDEX idx_temp_hum_device
ON temperature_humidity_data(device_id);

-- 组合索引（设备+时间）
CREATE INDEX idx_temp_hum_device_time
ON temperature_humidity_data(device_id, timestamp DESC);
```

**门锁事件表**:
```sql
-- 组合索引（锁ID + 时间）
CREATE INDEX idx_lock_events_lock_time
ON lock_events(lock_id, timestamp DESC);

-- 事件类型筛选索引
CREATE INDEX idx_lock_events_type
ON lock_events(event_type);
```

**空调事件表**:
```sql
CREATE INDEX idx_ac_events_ac_time
ON ac_events(ac_id, timestamp DESC);
```

**烟雾报警事件表**:
```sql
CREATE INDEX idx_smoke_alarm_events_alarm_time
ON smoke_alarm_events(alarm_id, timestamp DESC);

-- 报警类型索引（快速查询触发/清除事件）
CREATE INDEX idx_smoke_events_type
ON smoke_alarm_events(event_type);
```

**用户表**:
```sql
-- 用户名唯一索引
CREATE UNIQUE INDEX idx_lock_users_username
ON lock_users(username);
```

#### 4.2.2 索引选择原则

| 场景 | 索引类型 | 示例 |
|------|---------|------|
| 主键查询 | 主键索引（自动） | WHERE lock_id = 'FRONT_DOOR' |
| 时间范围查询 | B+树降序索引 | WHERE timestamp > '2024-01-01' |
| 组合查询 | 组合索引 | WHERE lock_id = 'xxx' AND timestamp > '...' |
| 唯一性约束 | 唯一索引 | username UNIQUE |
| 频繁JOIN字段 | 普通索引 | ON ac_state.device_id = sensor.device_id |

### 4.3 分区设计（生产环境）

#### 温湿度数据表按月分区

```sql
-- openGauss 分区表设计
CREATE TABLE temperature_humidity_data (
    id SERIAL,
    device_id VARCHAR(50),
    temperature FLOAT,
    humidity FLOAT,
    timestamp TIMESTAMP
) PARTITION BY RANGE (timestamp) (
    PARTITION p202401 VALUES LESS THAN ('2024-02-01'),
    PARTITION p202402 VALUES LESS THAN ('2024-03-01'),
    PARTITION p202403 VALUES LESS THAN ('2024-04-01')
    -- 自动归档旧分区
);
```

**分区优势**:
- 查询只扫描相关分区，提高性能
- 老数据分区可独立备份和归档
- 删除历史数据直接DROP分区，避免DELETE操作

### 4.4 存取方法选择

| 表名 | 访问模式 | 存取方法 | 理由 |
|------|---------|---------|------|
| lock_state | 主键查询为主 | B+树索引 | 快速定位单条记录 |
| temperature_humidity_data | 范围查询（时间） | B+树索引 + 分区 | 时间序列数据特征 |
| lock_events | 顺序插入 + 范围查询 | B+树索引（时间降序） | 审计日志特征 |
| lock_users | 唯一键查询 | 哈希索引（用户名） | 登录场景等值查询 |
| ac_state | 主键查询 | B+树索引 | 状态表快速更新 |

### 4.5 数据库配置参数（openGauss）

```conf
# 连接配置
max_connections = 200
shared_buffers = 2GB

# WAL配置
wal_level = replica
max_wal_size = 2GB

# 查询优化
effective_cache_size = 4GB
random_page_cost = 1.1

# 自动清理
autovacuum = on
autovacuum_naptime = 1min
```

### 4.6 物理设计评估

**评估指标**:

| 操作类型 | 预期性能 | 存储开销 | 维护代价 |
|---------|---------|---------|---------|
| 插入传感器数据 | < 10ms | 每条约50字节 | 低（自动分区） |
| 查询最新温湿度 | < 5ms | - | 低（有索引） |
| 门锁操作审计查询 | < 50ms（1000条） | 每条约100字节 | 低 |
| 空调状态更新 | < 5ms | 每条约150字节 | 低 |
| 烟雾报警查询 | < 10ms | 每条约80字节 | 低 |

**空间估算**（1年运行）:
- temperature_humidity_data: 2设备 × 43200条/月 × 12月 × 50字节 ≈ 52MB
- lock_events: 100条/月 × 12月 × 100字节 ≈ 120KB
- ac_events: 200条/月 × 12月 × 100字节 ≈ 240KB
- smoke_alarm_events: 50条/月 × 12月 × 80字节 ≈ 48KB
- **总计**: 约60MB（不含索引）

---

## 5. 数据库实施

### 5.1 数据库创建

#### 5.1.1 openGauss环境

```bash
# 连接到openGauss
gsql -d postgres -h 127.0.0.1 -p 7654 -U opengauss

# 执行初始化脚本
\i /path/to/init_db.sql
```

#### 5.1.2 SQLite环境（开发）

```bash
# 自动创建数据库（首次运行Flask应用时）
python backend/app.py
# database.py 中的 get_connection() 会自动建表
```

### 5.2 表结构定义（DDL语句）

#### 温湿度数据表

```sql
CREATE TABLE temperature_humidity_data (
    id SERIAL PRIMARY KEY,
    device_id VARCHAR(50) DEFAULT 'room1',
    temperature FLOAT NOT NULL,
    humidity FLOAT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_temp_hum_timestamp ON temperature_humidity_data(timestamp DESC);
CREATE INDEX idx_temp_hum_device ON temperature_humidity_data(device_id);
```

#### 智能门锁相关表

```sql
-- 门锁状态表
CREATE TABLE lock_state (
    lock_id VARCHAR(50) PRIMARY KEY,
    locked BOOLEAN NOT NULL,
    method VARCHAR(20),
    actor VARCHAR(64),
    battery INTEGER DEFAULT 100,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 门锁事件表
CREATE TABLE lock_events (
    id SERIAL PRIMARY KEY,
    lock_id VARCHAR(50) NOT NULL,
    event_type VARCHAR(32) NOT NULL,
    method VARCHAR(20),
    actor VARCHAR(64),
    detail TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_lock_events_lock_time ON lock_events(lock_id, timestamp DESC);

-- 授权用户表
CREATE TABLE lock_users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    pincode VARCHAR(10) NOT NULL,
    face_image_path VARCHAR(255),
    fingerprint_data TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 自动锁配置表
CREATE TABLE lock_auto_config (
    lock_id VARCHAR(50) PRIMARY KEY,
    auto_lock_enabled BOOLEAN DEFAULT true,
    auto_lock_delay INTEGER DEFAULT 5,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 智能空调相关表

```sql
-- 空调状态表
CREATE TABLE ac_state (
    ac_id VARCHAR(50) PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL,
    power BOOLEAN DEFAULT false,
    mode VARCHAR(20) DEFAULT 'cool',
    target_temp FLOAT DEFAULT 26.0,
    current_temp FLOAT,
    current_humidity FLOAT,
    fan_speed VARCHAR(20) DEFAULT 'auto',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 空调事件表
CREATE TABLE ac_events (
    id SERIAL PRIMARY KEY,
    ac_id VARCHAR(50) NOT NULL,
    event_type VARCHAR(32) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    detail TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ac_events_ac_time ON ac_events(ac_id, timestamp DESC);
```

#### 智能灯具相关表

```sql
-- 灯具状态表
CREATE TABLE lighting_state (
    light_id VARCHAR(50) PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL,
    power BOOLEAN DEFAULT false,
    brightness INTEGER DEFAULT 50,
    auto_mode BOOLEAN DEFAULT false,
    room_brightness FLOAT,
    color_temp INTEGER DEFAULT 4000,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 灯具事件表
CREATE TABLE lighting_events (
    id SERIAL PRIMARY KEY,
    light_id VARCHAR(50) NOT NULL,
    event_type VARCHAR(32) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    detail TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_lighting_events_light_time ON lighting_events(light_id, timestamp DESC);
```

#### 烟雾报警器相关表

```sql
-- 烟雾报警器状态表
CREATE TABLE smoke_alarm_state (
    alarm_id VARCHAR(50) PRIMARY KEY,
    location VARCHAR(50) NOT NULL,
    smoke_level FLOAT DEFAULT 0.0,
    alarm_active BOOLEAN DEFAULT false,
    battery INTEGER DEFAULT 100,
    test_mode BOOLEAN DEFAULT false,
    sensitivity VARCHAR(20) DEFAULT 'medium',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 烟雾报警器事件表
CREATE TABLE smoke_alarm_events (
    id SERIAL PRIMARY KEY,
    alarm_id VARCHAR(50) NOT NULL,
    event_type VARCHAR(32) NOT NULL,
    smoke_level FLOAT,
    detail TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_smoke_alarm_events_alarm_time ON smoke_alarm_events(alarm_id, timestamp DESC);
```

### 5.3 初始数据装载

#### 门锁初始化

```sql
-- 初始化大门锁状态
INSERT INTO lock_state (lock_id, locked, battery)
VALUES ('FRONT_DOOR', true, 100);

-- 初始化事件记录
INSERT INTO lock_events (lock_id, event_type, detail)
VALUES ('FRONT_DOOR', 'INIT', 'System initialized with locked state');
```

#### 空调初始化

```sql
-- 为每个房间初始化空调
INSERT INTO ac_state (ac_id, device_id, power, mode, target_temp, fan_speed)
VALUES
    ('ac_room1', 'room1', false, 'cool', 26.0, 'auto'),
    ('ac_room2', 'room2', false, 'cool', 26.0, 'auto');

-- 事件记录
INSERT INTO ac_events (ac_id, event_type, detail)
VALUES
    ('ac_room1', 'INIT', 'Air conditioner initialized'),
    ('ac_room2', 'INIT', 'Air conditioner initialized');
```

#### 烟雾报警器初始化

```sql
-- 为主要房间初始化报警器
INSERT INTO smoke_alarm_state (alarm_id, location, smoke_level, battery, sensitivity)
VALUES
    ('smoke_living_room', 'living_room', 0.0, 100, 'medium'),
    ('smoke_bedroom', 'bedroom', 0.0, 100, 'medium'),
    ('smoke_kitchen', 'kitchen', 0.0, 100, 'high');

INSERT INTO smoke_alarm_events (alarm_id, event_type, smoke_level, detail)
VALUES
    ('smoke_living_room', 'INIT', 0.0, 'Smoke alarm initialized'),
    ('smoke_bedroom', 'INIT', 0.0, 'Smoke alarm initialized'),
    ('smoke_kitchen', 'INIT', 0.0, 'Smoke alarm initialized');
```

#### 测试用户初始化（使用Python脚本）

```python
# init_lock_users.py
from backend.database import create_lock_user
from backend.auth import hash_password

users = [
    {
        'username': 'alice',
        'password': 'password123',
        'pincode': '1234'
    },
    {
        'username': 'bob',
        'password': 'password456',
        'pincode': '1234'
    }
]

for user in users:
    create_lock_user(
        username=user['username'],
        password_hash=hash_password(user['password']),
        pincode=user['pincode']
    )
```

### 5.4 应用程序开发

#### 数据库连接模块 (backend/database.py)

```python
import os
import sqlite3
import py_opengauss
from config import DB_TYPE, DB_CONFIG, DB_PATH

def get_connection():
    """双后端数据库连接"""
    if DB_TYPE == 'sqlite':
        conn = sqlite3.connect(DB_PATH)
        # 自动建表逻辑...
        return conn
    else:
        conn_string = f"opengauss://{DB_CONFIG['user']}:{DB_CONFIG['password']}@{DB_CONFIG['host']}:{DB_CONFIG['port']}/{DB_CONFIG['dbname']}"
        return py_opengauss.open(conn_string)
```

#### Flask API路由 (backend/routes/lock.py)

```python
from flask import Blueprint, request, jsonify
from backend.database import upsert_lock_state, get_lock_state

lock_bp = Blueprint('lock', __name__, url_prefix='/locks')

@lock_bp.route('/<lock_id>/command', methods=['POST'])
def lock_command(lock_id):
    data = request.json
    action = data.get('action')  # 'lock' or 'unlock'
    method = data.get('method')  # 'PINCODE'/'FINGERPRINT'/'FACE'

    # 验证用户权限
    if method == 'PINCODE':
        if not verify_pincode(data.get('pin')):
            return jsonify({'error': 'Invalid PIN'}), 403

    # 更新数据库
    upsert_lock_state(lock_id, locked=(action=='lock'), method=method, actor=data.get('actor'))

    # 发送MQTT控制指令
    publish_lock_command(lock_id, action, method, data.get('actor'))

    return jsonify({'status': 'success'})
```

### 5.5 系统联调与测试

#### 测试脚本

```bash
#!/bin/bash
# test_system.sh

echo "=== 测试数据库连接 ==="
python -c "from backend.database import get_connection; get_connection()"

echo "=== 测试传感器数据插入 ==="
curl -X POST http://localhost:5000/api/sensor/data \
  -H "Content-Type: application/json" \
  -d '{"device_id":"room1","temperature":25.5,"humidity":60.0}'

echo "=== 测试门锁控制 ==="
curl -X POST http://localhost:5000/locks/FRONT_DOOR/command \
  -H "Content-Type: application/json" \
  -d '{"action":"unlock","method":"PINCODE","pin":"1234","actor":"alice"}'

echo "=== 测试空调控制 ==="
curl -X POST http://localhost:5000/ac/ac_room1/control \
  -H "Content-Type: application/json" \
  -d '{"power":true,"mode":"cool","target_temp":24.0}'

echo "=== 测试烟雾报警器查询 ==="
curl http://localhost:5000/smoke_alarms/smoke_kitchen
```

#### 性能测试

```bash
# 使用Apache Bench进行压力测试
ab -n 1000 -c 10 http://localhost:5000/api/devices/status
```

### 5.6 数据转储与恢复

#### openGauss备份

```bash
# 逻辑备份
gs_dump smart_home -f /backup/smart_home_$(date +%Y%m%d).sql

# 恢复
gsql -d smart_home -f /backup/smart_home_20240101.sql
```

#### SQLite备份

```bash
# 文件复制即可
cp database.db database_backup_$(date +%Y%m%d).db
```

---

## 6. 运行与维护

### 6.1 数据库监控

#### 6.1.1 性能监控指标

**数据库级别**:
```sql
-- 查询慢查询（openGauss）
SELECT * FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC;

-- 检查表大小
SELECT
    tablename,
    pg_size_pretty(pg_total_relation_size(tablename::regclass)) AS size
FROM pg_tables
WHERE schemaname = 'public';
```

**应用级别**:
- Flask日志中的数据库操作耗时
- MQTT消息处理延迟
- API响应时间监控

#### 6.1.2 监控脚本

```python
# monitor.py
import psutil
import time
from backend.database import get_connection

def check_db_health():
    """数据库健康检查"""
    try:
        conn = get_connection()
        # 测试查询
        if DB_TYPE == 'sqlite':
            cur = conn.cursor()
            cur.execute("SELECT COUNT(*) FROM lock_state")
        else:
            stmt = conn.prepare("SELECT COUNT(*) FROM lock_state")
            stmt()
        print("✓ Database connection OK")
    except Exception as e:
        print(f"✗ Database error: {e}")
        # 发送告警...

def check_disk_space():
    """磁盘空间检查"""
    usage = psutil.disk_usage('/data')
    if usage.percent > 80:
        print(f"⚠ Disk usage high: {usage.percent}%")
        # 发送告警...

if __name__ == '__main__':
    while True:
        check_db_health()
        check_disk_space()
        time.sleep(300)  # 每5分钟检查
```

### 6.2 定期维护任务

#### 6.2.1 数据清理策略

```sql
-- 清理3个月前的传感器数据（每周执行）
DELETE FROM temperature_humidity_data
WHERE timestamp < NOW() - INTERVAL '3 months';

-- 清理1年前的事件记录（每月执行）
DELETE FROM lock_events
WHERE timestamp < NOW() - INTERVAL '1 year';

DELETE FROM ac_events
WHERE timestamp < NOW() - INTERVAL '1 year';

DELETE FROM smoke_alarm_events
WHERE timestamp < NOW() - INTERVAL '1 year';
```

#### 6.2.2 定时任务配置（Cron）

```bash
# /etc/crontab

# 每天凌晨2点备份数据库
0 2 * * * postgres gs_dump smart_home -f /backup/smart_home_$(date +\%Y\%m\%d).sql

# 每周日凌晨3点清理旧数据
0 3 * * 0 postgres psql -d smart_home -c "DELETE FROM temperature_humidity_data WHERE timestamp < NOW() - INTERVAL '3 months';"

# 每天凌晨4点执行VACUUM（优化存储）
0 4 * * * postgres psql -d smart_home -c "VACUUM ANALYZE;"
```

### 6.3 安全性维护

#### 6.3.1 权限管理

```sql
-- 创建只读用户（用于监控）
CREATE USER monitor_user WITH PASSWORD 'secure_password';
GRANT SELECT ON ALL TABLES IN SCHEMA public TO monitor_user;

-- 创建应用用户（读写权限）
CREATE USER app_user WITH PASSWORD 'app_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO app_user;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;
```

#### 6.3.2 审计日志

```sql
-- 启用openGauss审计
ALTER DATABASE smart_home SET log_statement = 'mod';  -- 记录所有修改操作
ALTER DATABASE smart_home SET log_duration = on;      -- 记录执行时间
```

### 6.4 性能调优

#### 6.4.1 索引维护

```sql
-- 检查未使用的索引
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND indexrelname NOT LIKE 'pg_toast%';

-- 重建索引（碎片整理）
REINDEX TABLE temperature_humidity_data;
```

#### 6.4.2 查询优化案例

**优化前**:
```sql
-- 查询最近1小时的平均温度（全表扫描）
SELECT AVG(temperature)
FROM temperature_humidity_data
WHERE timestamp > NOW() - INTERVAL '1 hour';
```

**优化后**:
```sql
-- 使用时间索引，只扫描相关数据
SELECT AVG(temperature)
FROM temperature_humidity_data
WHERE timestamp > NOW() - INTERVAL '1 hour'
AND device_id = 'room1';  -- 增加设备筛选，使用组合索引
```

### 6.5 数据库重组织与重构造

#### 6.5.1 重组织（不改变结构）

```sql
-- SQLite数据库重组织
VACUUM;

-- openGauss表重组织
VACUUM FULL temperature_humidity_data;
ANALYZE temperature_humidity_data;
```

#### 6.5.2 重构造（结构调整）

**场景：新增烟雾报警器功能**

```sql
-- 1. 创建新表
CREATE TABLE smoke_alarm_state (
    alarm_id VARCHAR(50) PRIMARY KEY,
    location VARCHAR(50) NOT NULL,
    smoke_level FLOAT DEFAULT 0.0,
    alarm_active BOOLEAN DEFAULT false,
    battery INTEGER DEFAULT 100,
    test_mode BOOLEAN DEFAULT false,
    sensitivity VARCHAR(20) DEFAULT 'medium',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. 创建事件表
CREATE TABLE smoke_alarm_events (
    id SERIAL PRIMARY KEY,
    alarm_id VARCHAR(50) NOT NULL,
    event_type VARCHAR(32) NOT NULL,
    smoke_level FLOAT,
    detail TEXT,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. 创建索引
CREATE INDEX idx_smoke_alarm_events_alarm_time
ON smoke_alarm_events(alarm_id, timestamp DESC);

-- 4. 初始化数据
INSERT INTO smoke_alarm_state (alarm_id, location, battery, sensitivity)
VALUES
    ('smoke_living_room', 'living_room', 100, 'medium'),
    ('smoke_bedroom', 'bedroom', 100, 'medium'),
    ('smoke_kitchen', 'kitchen', 100, 'high');

-- 5. 更新应用代码（backend/database.py, backend/routes/smoke_alarm.py）
-- 6. 更新MQTT订阅主题
```

**场景：扩容存储（添加新分区）**

```sql
-- 为下一年添加新分区
ALTER TABLE temperature_humidity_data
ADD PARTITION p202501 VALUES LESS THAN ('2025-02-01');

ALTER TABLE temperature_humidity_data
ADD PARTITION p202502 VALUES LESS THAN ('2025-03-01');
```

### 6.6 故障恢复预案

#### 场景1：数据库连接失败

```python
# backend/database.py 中的重试机制
def get_connection_with_retry(max_retries=3):
    for i in range(max_retries):
        try:
            return get_connection()
        except Exception as e:
            if i == max_retries - 1:
                raise
            time.sleep(2 ** i)  # 指数退避
```

#### 场景2：数据损坏恢复

```bash
# 1. 停止应用
pkill -f 'python.*backend'

# 2. 从最新备份恢复
gsql -d postgres -c "DROP DATABASE smart_home;"
gsql -d postgres -c "CREATE DATABASE smart_home;"
gsql -d smart_home -f /backup/smart_home_latest.sql

# 3. 重启应用
sh run.sh
```

#### 场景3：数据一致性检查

```sql
-- 检查孤立事件（引用不存在的lock_id）
SELECT lock_id
FROM lock_events
WHERE lock_id NOT IN (SELECT lock_id FROM lock_state);

-- 修复方法：删除孤立记录或补充状态表数据
```

### 6.7 容量规划

**未来1年增长预测**:

| 数据类型 | 当前量 | 预计增长 | 存储需求 |
|---------|--------|---------|---------|
| 传感器数据 | 5万条 | 100万条/年 | 50MB → 1GB |
| 门锁事件 | 100条 | 1200条/年 | 10KB → 120KB |
| 空调事件 | 200条 | 2400条/年 | 20KB → 240KB |
| 烟雾报警事件 | 50条 | 600条/年 | 5KB → 60KB |

**扩容建议**:
- 保留至少50% 磁盘空余空间
- 预计2年后启用分区归档机制
- 考虑冷热数据分离（历史数据迁移到归档库）

### 6.8 文档更新

维护以下技术文档：
1. **数据字典**：记录所有表结构、字段含义、约束关系
2. **变更日志**：记录每次数据库结构调整（DDL操作）
3. **备份记录**：记录备份时间、文件位置、恢复测试结果
4. **性能基线**：记录关键查询的基准性能指标
5. **运维手册**：常见问题处理流程、联系人信息

---

## 附录

### A. 参考资料

1. 《数据库系统概论》（第5版）- 王珊、萨师煊
2. openGauss官方文档: https://opengauss.org/zh/docs/
3. Flask-SQLAlchemy文档: https://flask-sqlalchemy.palletsprojects.com/
4. MQTT协议规范: https://mqtt.org/

### B. 工具清单

| 工具名称 | 用途 | 版本 |
|---------|------|------|
| openGauss | 生产数据库 | 5.x |
| SQLite | 开发数据库 | 3.x |
| Python | 后端开发 | 3.9+ |
| Flask | Web框架 | 2.x |
| paho-mqtt | MQTT客户端 | 1.x |
| py-opengauss | openGauss驱动 | 1.x |

### C. SQL脚本索引

| 脚本文件 | 说明 |
|---------|------|
| init_db.sql | 数据库初始化脚本 |
| create_user.sql | 用户和权限创建 |
| init_ac_only.sql | 空调模块初始化 |
| backup.sh | 自动备份脚本 |
| cleanup.sh | 数据清理脚本 |

### D. 修订历史

| 版本 | 日期 | 修订内容 | 作者 |
|------|------|---------|------|
| 1.0 | 2024-XX-XX | 初始版本，完成基础设计 | [您的姓名] |
| 1.1 | 2024-XX-XX | 新增烟雾报警器模块 | [您的姓名] |
| 1.2 | 2024-XX-XX | 优化索引设计，增加分区方案 | [您的姓名] |

---

**文档结束**
