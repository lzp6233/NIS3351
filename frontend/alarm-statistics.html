<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁªüËÆ°ÂàÜÊûê - NIS3351Êô∫ÊÖßÂÆ∂Â±Ö</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        nav {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        nav a:hover {
            opacity: 0.8;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .panel-title {
            font-size: 1.8em;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }

        .stat-value {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 8px;
            position: relative;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.95;
            position: relative;
        }

        .stat-trend {
            font-size: 0.85em;
            margin-top: 8px;
            opacity: 0.9;
            position: relative;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-weight: 500;
            color: #333;
        }

        .filters select,
        .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .device-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .device-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #007bff;
        }

        .device-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            color: #333;
        }

        .health-score {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .health-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            transition: width 0.5s;
        }

        .health-score-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
            font-size: 1.2em;
        }

        .summary-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .summary-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .summary-box-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .summary-box-label {
            color: #666;
            font-size: 0.9em;
        }

        .trend-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .trend-up {
            background: #d4edda;
            color: #155724;
        }

        .trend-down {
            background: #f8d7da;
            color: #721c24;
        }

        .date-range-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-btn:hover {
            color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">È¶ñÈ°µ</a>
            <a href="smoke-alarm.html">ÁÉüÈõæÊä•Ë≠¶Âô®</a>
            <a href="alarm-dashboard.html">Êä•Ë≠¶‰ª™Ë°®Êùø</a>
            <a href="alarm-statistics.html" style="font-weight: bold;">ÁªüËÆ°ÂàÜÊûê</a>
            <a href="device-maintenance.html">ËÆæÂ§áÁª¥Êä§</a>
            <a href="automation-rules.html">Ëá™Âä®ÂåñËßÑÂàô</a>
            <a href="room-management.html">ÊàøÈó¥ÁÆ°ÁêÜ</a>
        </nav>

        <header>
            <h1>üìä ÁªüËÆ°ÂàÜÊûê</h1>
            <p>ÂàÜÊûêÊä•Ë≠¶Êï∞ÊçÆÔºå‰ºòÂåñÁ≥ªÁªüÊÄßËÉΩ</p>
        </header>

        <!-- ÁªüËÆ°Ê¶ÇËßà -->
        <div class="panel">
            <h2 class="panel-title">Á≥ªÁªüÊ¶ÇËßà</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-alarms">0</div>
                    <div class="stat-label">ÊÄªÊä•Ë≠¶Ê¨°Êï∞</div>
                    <div class="stat-trend" id="alarm-trend">--</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <div class="stat-value" id="false-alarm-rate">0%</div>
                    <div class="stat-label">ËØØÊä•Áéá</div>
                    <div class="stat-trend" id="false-alarm-trend">--</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <div class="stat-value" id="avg-response-time">0s</div>
                    <div class="stat-label">Âπ≥ÂùáÂìçÂ∫îÊó∂Èó¥</div>
                    <div class="stat-trend" id="response-trend">--</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <div class="stat-value" id="system-health">100%</div>
                    <div class="stat-label">Á≥ªÁªüÂÅ•Â∫∑Â∫¶</div>
                    <div class="stat-trend">‚úì ‰ºòÁßÄ</div>
                </div>
            </div>
        </div>

        <!-- Êï∞ÊçÆÁ≠õÈÄâ -->
        <div class="panel">
            <div class="date-range-selector">
                <label>Êó∂Èó¥ËåÉÂõ¥:</label>
                <select id="date-range" onchange="loadStatistics()">
                    <option value="7">ÊúÄËøë7Â§©</option>
                    <option value="30" selected>ÊúÄËøë30Â§©</option>
                    <option value="90">ÊúÄËøë90Â§©</option>
                    <option value="365">ÊúÄËøë‰∏ÄÂπ¥</option>
                </select>

                <label style="margin-left: 20px;">ËÆæÂ§á:</label>
                <select id="device-filter" onchange="loadStatistics()">
                    <option value="">ÂÖ®ÈÉ®ËÆæÂ§á</option>
                </select>

                <button class="btn btn-primary" onclick="loadStatistics()" style="margin-left: auto;">
                    üîÑ Âà∑Êñ∞Êï∞ÊçÆ
                </button>
            </div>
        </div>

        <!-- Ê†áÁ≠æÈ°µ -->
        <div class="panel">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('overview')">ÊÄªËßà</button>
                <button class="tab-btn" onclick="switchTab('trends')">Ë∂ãÂäøÂàÜÊûê</button>
                <button class="tab-btn" onclick="switchTab('devices')">ËÆæÂ§áÂØπÊØî</button>
                <button class="tab-btn" onclick="switchTab('performance')">ÊÄßËÉΩËØÑ‰º∞</button>
            </div>

            <!-- ÊÄªËßàÊ†áÁ≠æÈ°µ -->
            <div id="tab-overview" class="tab-content active">
                <div class="summary-boxes">
                    <div class="summary-box">
                        <div class="summary-box-value" id="real-alarms">0</div>
                        <div class="summary-box-label">ÁúüÂÆûÊä•Ë≠¶</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-value" id="false-alarms">0</div>
                        <div class="summary-box-label">ËØØÊä•Ê¨°Êï∞</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-value" id="acknowledged-alarms">0</div>
                        <div class="summary-box-label">Â∑≤Á°ÆËÆ§</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-value" id="unacknowledged-alarms">0</div>
                        <div class="summary-box-label">Êú™Á°ÆËÆ§</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="alarm-overview-chart"></canvas>
                </div>
            </div>

            <!-- Ë∂ãÂäøÂàÜÊûêÊ†áÁ≠æÈ°µ -->
            <div id="tab-trends" class="tab-content">
                <div class="chart-grid">
                    <div class="chart-container">
                        <h3 style="margin-bottom: 15px;">Êä•Ë≠¶Ë∂ãÂäø</h3>
                        <canvas id="alarm-trend-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="margin-bottom: 15px;">ËØØÊä•ÁéáË∂ãÂäø</h3>
                        <canvas id="false-alarm-trend-chart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="margin-bottom: 15px;">ÊØèÊó•Êä•Ë≠¶ÂàÜÂ∏É</h3>
                    <canvas id="daily-distribution-chart"></canvas>
                </div>
            </div>

            <!-- ËÆæÂ§áÂØπÊØîÊ†áÁ≠æÈ°µ -->
            <div id="tab-devices" class="tab-content">
                <div id="device-comparison" class="device-comparison">
                    <div class="loading">Ê≠£Âú®Âä†ËΩΩËÆæÂ§áÊï∞ÊçÆ...</div>
                </div>
            </div>

            <!-- ÊÄßËÉΩËØÑ‰º∞Ê†áÁ≠æÈ°µ -->
            <div id="tab-performance" class="tab-content">
                <div class="summary-boxes">
                    <div class="summary-box">
                        <div class="summary-box-value" id="avg-smoke-level">0%</div>
                        <div class="summary-box-label">Âπ≥ÂùáÁÉüÈõæÊµìÂ∫¶</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-value" id="max-smoke-level">0%</div>
                        <div class="summary-box-label">ÊúÄÈ´òÁÉüÈõæÊµìÂ∫¶</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-value" id="low-battery-count">0</div>
                        <div class="summary-box-label">‰ΩéÁîµÈáèËÆæÂ§á</div>
                    </div>
                    <div class="summary-box">
                        <div class="summary-box-value" id="maintenance-due">0</div>
                        <div class="summary-box-label">ÂæÖÁª¥Êä§ËÆæÂ§á</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="margin-bottom: 15px;">ËÆæÂ§áÂÅ•Â∫∑Â∫¶ËØÑÂàÜ</h3>
                    <canvas id="health-score-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Socket.IO ÂÆ¢Êà∑Á´ØÂ∫ì -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        const API_BASE = 'http://localhost:5000';
        let allAlarms = [];
        let allEvents = [];
        let statistics = null;
        let charts = {};
        let socket;

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.onload = async function() {
            await loadAlarms();
            await loadEvents();
            await loadStatistics();
            // ÂàùÂßãÂåñWebSocket
            initWebSocket();
        };

        // ÂàùÂßãÂåñWebSocketËøûÊé•
        function initWebSocket() {
            try {
                socket = io(API_BASE, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 5
                });

                socket.on('connect', () => {
                    console.log('‚úì WebSocket Â∑≤ËøûÊé• - ÁªüËÆ°È°µÈù¢Â∞ÜÂÆûÊó∂Êõ¥Êñ∞');
                });

                socket.on('disconnect', () => {
                    console.log('‚úó WebSocket Â∑≤Êñ≠ÂºÄ');
                });

                // ÁõëÂê¨ÁÉüÈõæÊä•Ë≠¶Âô®Áä∂ÊÄÅÊõ¥Êñ∞
                socket.on('smoke_alarm_state_update', (data) => {
                    console.log('üì® ÁªüËÆ°È°µÈù¢Êî∂Âà∞Áä∂ÊÄÅÊõ¥Êñ∞:', data);
                    handleRealtimeUpdate(data);
                });

                // ÁõëÂê¨ÁÉüÈõæÊä•Ë≠¶Âô®‰∫ã‰ª∂
                socket.on('smoke_alarm_event', (data) => {
                    console.log('üö® ÁªüËÆ°È°µÈù¢Êî∂Âà∞‰∫ã‰ª∂:', data);
                    handleRealtimeEvent(data);
                });

                socket.on('connect_error', (error) => {
                    console.error('WebSocket ËøûÊé•ÈîôËØØ:', error);
                });
            } catch (error) {
                console.error('ÂàùÂßãÂåñWebSocketÂ§±Ë¥•:', error);
            }
        }

        // Â§ÑÁêÜÂÆûÊó∂Áä∂ÊÄÅÊõ¥Êñ∞
        function handleRealtimeUpdate(data) {
            // Êõ¥Êñ∞Êú¨Âú∞Êï∞ÊçÆ
            const index = allAlarms.findIndex(a => a.alarm_id === data.alarm_id);
            if (index !== -1) {
                allAlarms[index].smoke_level = data.smoke_level;
                allAlarms[index].alarm_active = data.alarm_active;
                allAlarms[index].battery = data.battery;
                allAlarms[index].test_mode = data.test_mode;
            }

            // Êõ¥Êñ∞ËÆæÂ§áÂØπÊØîÂç°Áâá
            updateDeviceComparison();

            // Êõ¥Êñ∞ÊÄßËÉΩÊåáÊ†á
            updatePerformanceMetrics();
        }

        // Â§ÑÁêÜÂÆûÊó∂‰∫ã‰ª∂
        function handleRealtimeEvent(data) {
            // Ê∑ªÂä†Âà∞‰∫ã‰ª∂ÂàóË°®
            allEvents.unshift({
                alarm_id: data.alarm_id,
                event_type: data.event_type,
                smoke_level: data.smoke_level,
                detail: data.detail,
                timestamp: new Date().toISOString()
            });

            // ÈôêÂà∂ÂàóË°®ÈïøÂ∫¶
            if (allEvents.length > 1000) {
                allEvents = allEvents.slice(0, 1000);
            }

            // Â¶ÇÊûúÊòØÊä•Ë≠¶‰∫ã‰ª∂ÔºåÊõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
            if (data.event_type === 'ALARM_TRIGGERED') {
                // Ëß¶ÂèëÁªüËÆ°Êï∞ÊçÆÂà∑Êñ∞
                debounceReloadStatistics();
            }
        }

        // Èò≤ÊäñÈáçÊñ∞Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
        let reloadTimer;
        function debounceReloadStatistics() {
            clearTimeout(reloadTimer);
            reloadTimer = setTimeout(() => {
                loadStatistics();
            }, 2000); // 2ÁßíÂêéÂà∑Êñ∞ÁªüËÆ°
        }

        // Êõ¥Êñ∞ÊÄßËÉΩÊåáÊ†á
        function updatePerformanceMetrics() {
            // Êõ¥Êñ∞Âπ≥ÂùáÁÉüÈõæÊµìÂ∫¶
            const avgSmoke = allAlarms.reduce((sum, a) => sum + a.smoke_level, 0) / allAlarms.length;
            document.getElementById('avg-smoke-level').textContent = `${avgSmoke.toFixed(1)}%`;

            // Êõ¥Êñ∞ÊúÄÈ´òÁÉüÈõæÊµìÂ∫¶
            const maxSmoke = Math.max(...allAlarms.map(a => a.smoke_level));
            document.getElementById('max-smoke-level').textContent = `${maxSmoke.toFixed(1)}%`;

            // Êõ¥Êñ∞‰ΩéÁîµÈáèËÆæÂ§áÊï∞
            const lowBattery = allAlarms.filter(a => (a.battery || 100) < 20).length;
            document.getElementById('low-battery-count').textContent = lowBattery;
        }

        // È°µÈù¢Âç∏ËΩΩÊó∂Êñ≠ÂºÄËøûÊé•
        window.addEventListener('beforeunload', () => {
            if (socket) {
                socket.disconnect();
            }
        });

        // Âä†ËΩΩÊä•Ë≠¶Âô®ÂàóË°®
        async function loadAlarms() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms`);
                allAlarms = await response.json();

                const select = document.getElementById('device-filter');
                allAlarms.forEach(alarm => {
                    const option = document.createElement('option');
                    option.value = alarm.alarm_id;
                    option.textContent = `${alarm.alarm_id} (${alarm.location || 'Êú™Áü•‰ΩçÁΩÆ'})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Âä†ËΩΩÊä•Ë≠¶Âô®Â§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩ‰∫ã‰ª∂Êï∞ÊçÆ
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/events?limit=1000`);
                const data = await response.json();
                allEvents = data.events || [];
            } catch (error) {
                console.error('Âä†ËΩΩ‰∫ã‰ª∂Â§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆ
        async function loadStatistics() {
            try {
                const days = document.getElementById('date-range').value;
                const device = document.getElementById('device-filter').value;

                let url = `${API_BASE}/smoke_alarms/statistics?days=${days}`;
                if (device) {
                    url += `&alarm_id=${device}`;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    statistics = data.statistics;
                    updateOverviewStats();
                    updateCharts();
                    updateDeviceComparison();
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // Êõ¥Êñ∞Ê¶ÇËßàÁªüËÆ°
        function updateOverviewStats() {
            if (!statistics) return;

            document.getElementById('total-alarms').textContent = statistics.total_alarms || 0;
            document.getElementById('false-alarm-rate').textContent =
                `${((statistics.false_alarms / statistics.total_alarms * 100) || 0).toFixed(1)}%`;
            document.getElementById('avg-response-time').textContent =
                `${statistics.avg_response_time || 0}s`;

            // ËÆ°ÁÆóÁ≥ªÁªüÂÅ•Â∫∑Â∫¶
            const health = calculateSystemHealth(statistics);
            document.getElementById('system-health').textContent = `${health}%`;

            // Êõ¥Êñ∞ËØ¶ÁªÜÁªüËÆ°
            document.getElementById('real-alarms').textContent = statistics.real_alarms || 0;
            document.getElementById('false-alarms').textContent = statistics.false_alarms || 0;
            document.getElementById('acknowledged-alarms').textContent = statistics.acknowledged || 0;
            document.getElementById('unacknowledged-alarms').textContent =
                (statistics.total_alarms - (statistics.acknowledged || 0)) || 0;
        }

        // Êõ¥Êñ∞ÂõæË°®
        function updateCharts() {
            updateOverviewChart();
            updateTrendCharts();
            updateHealthScoreChart();
        }

        // Êõ¥Êñ∞ÊÄªËßàÂõæË°®
        function updateOverviewChart() {
            const ctx = document.getElementById('alarm-overview-chart');

            if (charts.overview) {
                charts.overview.destroy();
            }

            charts.overview = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ÁúüÂÆûÊä•Ë≠¶', 'ËØØÊä•', 'Êú™Á°ÆËÆ§'],
                    datasets: [{
                        data: [
                            statistics.real_alarms || 0,
                            statistics.false_alarms || 0,
                            statistics.total_alarms - (statistics.acknowledged || 0)
                        ],
                        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Êä•Ë≠¶ÂàÜÂ∏ÉÊ¶ÇËßà'
                        }
                    }
                }
            });
        }

        // Êõ¥Êñ∞Ë∂ãÂäøÂõæË°®
        function updateTrendCharts() {
            // Ê®°ÊãüË∂ãÂäøÊï∞ÊçÆÔºàÂÆûÈôÖÂ∫î‰ªéÂêéÁ´ØËé∑ÂèñÔºâ
            const days = parseInt(document.getElementById('date-range').value);
            const dates = [];
            const alarmCounts = [];
            const falseAlarmRates = [];

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));

                // Ê®°ÊãüÊï∞ÊçÆ
                alarmCounts.push(Math.floor(Math.random() * 10));
                falseAlarmRates.push(Math.floor(Math.random() * 30));
            }

            // Êä•Ë≠¶Ë∂ãÂäøÂõæ
            const trendCtx = document.getElementById('alarm-trend-chart');
            if (charts.trend) charts.trend.destroy();

            charts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Êä•Ë≠¶Ê¨°Êï∞',
                        data: alarmCounts,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // ËØØÊä•ÁéáË∂ãÂäøÂõæ
            const falseAlarmCtx = document.getElementById('false-alarm-trend-chart');
            if (charts.falseAlarmTrend) charts.falseAlarmTrend.destroy();

            charts.falseAlarmTrend = new Chart(falseAlarmCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'ËØØÊä•Áéá (%)',
                        data: falseAlarmRates,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // ÊØèÊó•ÂàÜÂ∏ÉÂõæ
            const distributionCtx = document.getElementById('daily-distribution-chart');
            if (charts.distribution) charts.distribution.destroy();

            const hourlyData = Array(24).fill(0).map(() => Math.floor(Math.random() * 5));

            charts.distribution = new Chart(distributionCtx, {
                type: 'bar',
                data: {
                    labels: Array(24).fill(0).map((_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Êä•Ë≠¶Ê¨°Êï∞',
                        data: hourlyData,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }

        // Êõ¥Êñ∞ËÆæÂ§áÂØπÊØî
        function updateDeviceComparison() {
            const container = document.getElementById('device-comparison');
            container.innerHTML = '';

            allAlarms.forEach(alarm => {
                const alarmEvents = allEvents.filter(e => e.alarm_id === alarm.alarm_id);
                const alarmTriggered = alarmEvents.filter(e => e.event_type === 'ALARM_TRIGGERED').length;
                const health = calculateDeviceHealth(alarm, alarmEvents);

                const card = document.createElement('div');
                card.className = 'device-card';
                card.innerHTML = `
                    <div class="device-name">${alarm.alarm_id}</div>
                    <div class="metric-row">
                        <span class="metric-label">‰ΩçÁΩÆ</span>
                        <span class="metric-value">${alarm.location || 'Êú™Áü•'}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Êä•Ë≠¶Ê¨°Êï∞</span>
                        <span class="metric-value">${alarmTriggered}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">ÂΩìÂâçÁÉüÈõæÊµìÂ∫¶</span>
                        <span class="metric-value">${alarm.smoke_level.toFixed(1)}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">ÁîµÊ±†ÁîµÈáè</span>
                        <span class="metric-value">${alarm.battery || 100}%</span>
                    </div>
                    <div class="health-score">
                        <span>ÂÅ•Â∫∑Â∫¶:</span>
                        <div class="health-bar">
                            <div class="health-bar-fill" style="width: ${health}%"></div>
                        </div>
                        <span class="health-score-value">${health}%</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Êõ¥Êñ∞ÂÅ•Â∫∑Â∫¶ËØÑÂàÜÂõæË°®
        function updateHealthScoreChart() {
            const ctx = document.getElementById('health-score-chart');
            if (charts.health) charts.health.destroy();

            const deviceNames = allAlarms.map(a => a.alarm_id);
            const healthScores = allAlarms.map(a => {
                const events = allEvents.filter(e => e.alarm_id === a.alarm_id);
                return calculateDeviceHealth(a, events);
            });

            charts.health = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: deviceNames,
                    datasets: [{
                        label: 'ÂÅ•Â∫∑Â∫¶ËØÑÂàÜ',
                        data: healthScores,
                        backgroundColor: healthScores.map(score =>
                            score >= 80 ? '#28a745' :
                            score >= 60 ? '#ffc107' : '#dc3545'
                        )
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // ËÆ°ÁÆóÁ≥ªÁªüÂÅ•Â∫∑Â∫¶
        function calculateSystemHealth(stats) {
            let score = 100;

            // Ê†πÊçÆËØØÊä•ÁéáÊâ£ÂàÜ
            const falseAlarmRate = (stats.false_alarms / stats.total_alarms) || 0;
            score -= falseAlarmRate * 30;

            // Ê†πÊçÆÂìçÂ∫îÊó∂Èó¥Êâ£ÂàÜ
            if (stats.avg_response_time > 60) {
                score -= 20;
            } else if (stats.avg_response_time > 30) {
                score -= 10;
            }

            // Ê†πÊçÆ‰ΩéÁîµÈáèËÆæÂ§áÊâ£ÂàÜÔºà‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ≠óÊÆµÂêç batteryÔºâ
            const lowBatteryCount = allAlarms.filter(a => (a.battery || 100) < 20).length;
            score -= lowBatteryCount * 5;

            return Math.max(0, Math.round(score));
        }

        // ËÆ°ÁÆóËÆæÂ§áÂÅ•Â∫∑Â∫¶
        function calculateDeviceHealth(alarm, events) {
            let score = 100;

            // ÁîµÊ±†ÁîµÈáèÔºà‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ≠óÊÆµÂêç batteryÔºâ
            const batteryLevel = alarm.battery || 100;
            if (batteryLevel < 20) {
                score -= 30;
            } else if (batteryLevel < 50) {
                score -= 15;
            }

            // ÂΩìÂâçÁÉüÈõæÊµìÂ∫¶ÔºàÈùûÊä•Ë≠¶Áä∂ÊÄÅ‰∏ãËøáÈ´òÔºå‰ΩøÁî®Ê≠£Á°ÆÁöÑÂ≠óÊÆµÂêç alarm_activeÔºâ
            if (!alarm.alarm_active && alarm.smoke_level > 20) {
                score -= 20;
            }

            // Êä•Ë≠¶È¢ëÁéá
            const alarmCount = events.filter(e => e.event_type === 'ALARM_TRIGGERED').length;
            if (alarmCount > 10) {
                score -= 20;
            } else if (alarmCount > 5) {
                score -= 10;
            }

            return Math.max(0, Math.round(score));
        }

        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function switchTab(tab) {
            // Êõ¥Êñ∞ÊåâÈíÆ
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Êõ¥Êñ∞ÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
    </script>
</body>
</html>
