<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªåŠ¨åŒ–è§„åˆ™é…ç½® - NIS3351æ™ºæ…§å®¶å±…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        nav {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        nav a:hover {
            opacity: 0.8;
        }

        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .rules-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .rules-table th,
        .rules-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .rules-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }

        .rules-table tr:hover {
            background: #f8f9fa;
        }

        .rule-enabled {
            color: #28a745;
            font-weight: bold;
        }

        .rule-disabled {
            color: #dc3545;
            font-weight: bold;
        }

        .priority-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .priority-high {
            background: #dc3545;
            color: white;
        }

        .priority-medium {
            background: #ffc107;
            color: #333;
        }

        .priority-low {
            background: #6c757d;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
        }

        .close {
            font-size: 2em;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group .hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }

        .rule-description {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">é¦–é¡µ</a>
            <a href="smoke-alarm.html">çƒŸé›¾æŠ¥è­¦å™¨</a>
            <a href="alarm-dashboard.html">æŠ¥è­¦ä»ªè¡¨æ¿</a>
            <a href="alarm-statistics.html">ç»Ÿè®¡åˆ†æ</a>
            <a href="device-maintenance.html">è®¾å¤‡ç»´æŠ¤</a>
            <a href="automation-rules.html" style="font-weight: bold;">è‡ªåŠ¨åŒ–è§„åˆ™</a>
            <a href="room-management.html">æˆ¿é—´ç®¡ç†</a>
        </nav>

        <header>
            <h1>âš™ï¸ è‡ªåŠ¨åŒ–è§„åˆ™é…ç½®</h1>
            <p>é…ç½®çƒŸé›¾æŠ¥è­¦å™¨è§¦å‘æ—¶çš„è‡ªåŠ¨åŒ–å“åº”</p>
        </header>

        <div class="content-section">
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-rules">0</div>
                    <div class="stat-label">æ€»è§„åˆ™æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="enabled-rules">0</div>
                    <div class="stat-label">å·²å¯ç”¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="disabled-rules">0</div>
                    <div class="stat-label">å·²ç¦ç”¨</div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">è§„åˆ™åˆ—è¡¨</h2>
                <button class="btn btn-primary" onclick="openCreateModal()">
                    + åˆ›å»ºæ–°è§„åˆ™
                </button>
            </div>

            <div class="filter-bar">
                <label>ç­›é€‰:</label>
                <select id="filter-enabled" onchange="loadRules()">
                    <option value="all">å…¨éƒ¨è§„åˆ™</option>
                    <option value="enabled">ä»…å¯ç”¨</option>
                    <option value="disabled">ä»…ç¦ç”¨</option>
                </select>
                <select id="filter-action" onchange="loadRules()">
                    <option value="">å…¨éƒ¨åŠ¨ä½œç±»å‹</option>
                    <option value="unlock_door">è§£é”é—¨é”</option>
                    <option value="turn_off_ac">å…³é—­ç©ºè°ƒ</option>
                    <option value="turn_on_lights">æ‰“å¼€ç…§æ˜</option>
                    <option value="send_notification">å‘é€é€šçŸ¥</option>
                    <option value="trigger_alarm">è§¦å‘è­¦æŠ¥</option>
                </select>
            </div>

            <div id="loading" class="loading">æ­£åœ¨åŠ è½½è§„åˆ™...</div>

            <div id="rules-container" style="display: none;">
                <table class="rules-table">
                    <thead>
                        <tr>
                            <th>è§„åˆ™åç§°</th>
                            <th>è§¦å‘æ¡ä»¶</th>
                            <th>æ‰§è¡ŒåŠ¨ä½œ</th>
                            <th>ç›®æ ‡è®¾å¤‡</th>
                            <th>ä¼˜å…ˆçº§</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="rules-table-body">
                    </tbody>
                </table>
            </div>

            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ğŸ“‹</div>
                <h3>æš‚æ— è§„åˆ™</h3>
                <p>ç‚¹å‡»"åˆ›å»ºæ–°è§„åˆ™"æŒ‰é’®å¼€å§‹é…ç½®è‡ªåŠ¨åŒ–å“åº”</p>
            </div>
        </div>
    </div>

    <!-- åˆ›å»º/ç¼–è¾‘è§„åˆ™æ¨¡æ€æ¡† -->
    <div id="rule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">åˆ›å»ºæ–°è§„åˆ™</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>

            <form id="rule-form" onsubmit="submitRule(event)">
                <input type="hidden" id="rule-id" value="">

                <div class="form-group">
                    <label for="rule-name">è§„åˆ™åç§° *</label>
                    <input type="text" id="rule-name" required>
                    <div class="hint">ç»™è§„åˆ™èµ·ä¸€ä¸ªæè¿°æ€§çš„åç§°</div>
                </div>

                <div class="form-group">
                    <label for="alarm-id">çƒŸé›¾æŠ¥è­¦å™¨</label>
                    <select id="alarm-id">
                        <option value="">å…¨éƒ¨æŠ¥è­¦å™¨</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="room-id">æˆ¿é—´</label>
                    <select id="room-id">
                        <option value="">å…¨éƒ¨æˆ¿é—´</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="trigger-condition">è§¦å‘æ¡ä»¶ *</label>
                    <select id="trigger-condition" required onchange="updateConditionValueHint()">
                        <option value="alarm_triggered">æŠ¥è­¦è§¦å‘</option>
                        <option value="smoke_level_threshold">çƒŸé›¾æµ“åº¦é˜ˆå€¼</option>
                        <option value="battery_low">ç”µæ± ç”µé‡ä½</option>
                        <option value="test_mode_activated">æµ‹è¯•æ¨¡å¼æ¿€æ´»</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="condition-value">æ¡ä»¶å€¼</label>
                    <input type="number" id="condition-value" step="0.1">
                    <div class="hint" id="condition-value-hint">å¯¹äºæŠ¥è­¦è§¦å‘ï¼Œä½¿ç”¨ 1</div>
                </div>

                <div class="form-group">
                    <label for="action-type">æ‰§è¡ŒåŠ¨ä½œ *</label>
                    <select id="action-type" required>
                        <option value="unlock_door">è§£é”é—¨é”</option>
                        <option value="turn_off_ac">å…³é—­ç©ºè°ƒ</option>
                        <option value="turn_on_lights">æ‰“å¼€ç…§æ˜</option>
                        <option value="send_notification">å‘é€é€šçŸ¥</option>
                        <option value="trigger_alarm">è§¦å‘è­¦æŠ¥</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="action-target">ç›®æ ‡è®¾å¤‡ID</label>
                    <input type="text" id="action-target">
                    <div class="hint">ä¾‹å¦‚: FRONT_DOOR, ac_kitchen, light_living</div>
                </div>

                <div class="form-group">
                    <label for="action-params">åŠ¨ä½œå‚æ•° (JSONæ ¼å¼)</label>
                    <textarea id="action-params">{"reason": "emergency"}</textarea>
                    <div class="hint">JSONæ ¼å¼çš„é¢å¤–å‚æ•°</div>
                </div>

                <div class="form-group">
                    <label for="priority">ä¼˜å…ˆçº§</label>
                    <select id="priority">
                        <option value="0">ä½</option>
                        <option value="1" selected>ä¸­</option>
                        <option value="2">é«˜</option>
                    </select>
                </div>

                <div class="form-group checkbox-group">
                    <input type="checkbox" id="enabled" checked>
                    <label for="enabled">å¯ç”¨æ­¤è§„åˆ™</label>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="btn btn-success">ä¿å­˜è§„åˆ™</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let allRules = [];
        let allAlarms = [];
        let allRooms = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            await loadAlarms();
            await loadRooms();
            await loadRules();
        };

        // åŠ è½½çƒŸé›¾æŠ¥è­¦å™¨åˆ—è¡¨
        async function loadAlarms() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms`);
                allAlarms = await response.json();

                const select = document.getElementById('alarm-id');
                allAlarms.forEach(alarm => {
                    const option = document.createElement('option');
                    option.value = alarm.alarm_id;
                    option.textContent = `${alarm.alarm_id} (${alarm.location || 'æœªçŸ¥ä½ç½®'})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½æŠ¥è­¦å™¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½æˆ¿é—´åˆ—è¡¨
        async function loadRooms() {
            try {
                const response = await fetch(`${API_BASE}/rooms`);
                const data = await response.json();
                allRooms = data.rooms || [];

                const select = document.getElementById('room-id');
                allRooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.room_id;
                    option.textContent = room.room_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´å¤±è´¥:', error);
            }
        }

        // åŠ è½½è§„åˆ™åˆ—è¡¨
        async function loadRules() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('rules-container').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';

                const response = await fetch(`${API_BASE}/automation/rules`);
                const data = await response.json();

                if (data.success) {
                    allRules = data.rules || [];

                    // åº”ç”¨ç­›é€‰
                    const filterEnabled = document.getElementById('filter-enabled').value;
                    const filterAction = document.getElementById('filter-action').value;

                    let filteredRules = allRules;

                    if (filterEnabled === 'enabled') {
                        filteredRules = filteredRules.filter(r => r.enabled);
                    } else if (filterEnabled === 'disabled') {
                        filteredRules = filteredRules.filter(r => !r.enabled);
                    }

                    if (filterAction) {
                        filteredRules = filteredRules.filter(r => r.action_type === filterAction);
                    }

                    displayRules(filteredRules);
                    updateStats();
                }
            } catch (error) {
                console.error('åŠ è½½è§„åˆ™å¤±è´¥:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºè§„åˆ™åˆ—è¡¨
        function displayRules(rules) {
            const tbody = document.getElementById('rules-table-body');
            tbody.innerHTML = '';

            if (rules.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            }

            document.getElementById('rules-container').style.display = 'block';

            rules.forEach(rule => {
                const row = document.createElement('tr');

                const priorityClass = rule.priority >= 2 ? 'priority-high' :
                                     rule.priority >= 1 ? 'priority-medium' : 'priority-low';
                const priorityText = rule.priority >= 2 ? 'é«˜' :
                                    rule.priority >= 1 ? 'ä¸­' : 'ä½';

                row.innerHTML = `
                    <td>
                        <strong>${rule.rule_name}</strong>
                        ${rule.room_id ? `<br><small>æˆ¿é—´: ${rule.room_id}</small>` : ''}
                    </td>
                    <td>${getConditionText(rule.trigger_condition, rule.condition_value)}</td>
                    <td>${getActionText(rule.action_type)}</td>
                    <td>${rule.action_target || 'æœªæŒ‡å®š'}</td>
                    <td><span class="priority-badge ${priorityClass}">${priorityText}</span></td>
                    <td><span class="${rule.enabled ? 'rule-enabled' : 'rule-disabled'}">
                        ${rule.enabled ? 'âœ“ å·²å¯ç”¨' : 'âœ— å·²ç¦ç”¨'}
                    </span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="editRule(${rule.rule_id})">ç¼–è¾‘</button>
                            <button class="btn btn-sm ${rule.enabled ? 'btn-secondary' : 'btn-success'}"
                                    onclick="toggleRule(${rule.rule_id}, ${!rule.enabled})">
                                ${rule.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.rule_id})">åˆ é™¤</button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const total = allRules.length;
            const enabled = allRules.filter(r => r.enabled).length;
            const disabled = total - enabled;

            document.getElementById('total-rules').textContent = total;
            document.getElementById('enabled-rules').textContent = enabled;
            document.getElementById('disabled-rules').textContent = disabled;
        }

        // è·å–æ¡ä»¶æ–‡æœ¬
        function getConditionText(condition, value) {
            const conditions = {
                'alarm_triggered': 'æŠ¥è­¦è§¦å‘',
                'smoke_level_threshold': `çƒŸé›¾æµ“åº¦ > ${value || '?'}`,
                'battery_low': `ç”µæ± ç”µé‡ < ${value || '?'}%`,
                'test_mode_activated': 'æµ‹è¯•æ¨¡å¼æ¿€æ´»'
            };
            return conditions[condition] || condition;
        }

        // è·å–åŠ¨ä½œæ–‡æœ¬
        function getActionText(action) {
            const actions = {
                'unlock_door': 'ğŸ”“ è§£é”é—¨é”',
                'turn_off_ac': 'â„ï¸ å…³é—­ç©ºè°ƒ',
                'turn_on_lights': 'ğŸ’¡ æ‰“å¼€ç…§æ˜',
                'send_notification': 'ğŸ“§ å‘é€é€šçŸ¥',
                'trigger_alarm': 'ğŸš¨ è§¦å‘è­¦æŠ¥'
            };
            return actions[action] || action;
        }

        // æ‰“å¼€åˆ›å»ºæ¨¡æ€æ¡†
        function openCreateModal() {
            document.getElementById('modal-title').textContent = 'åˆ›å»ºæ–°è§„åˆ™';
            document.getElementById('rule-form').reset();
            document.getElementById('rule-id').value = '';
            document.getElementById('enabled').checked = true;
            document.getElementById('action-params').value = '{"reason": "emergency"}';
            document.getElementById('rule-modal').style.display = 'block';
        }

        // ç¼–è¾‘è§„åˆ™
        async function editRule(ruleId) {
            const rule = allRules.find(r => r.rule_id === ruleId);
            if (!rule) return;

            document.getElementById('modal-title').textContent = 'ç¼–è¾‘è§„åˆ™';
            document.getElementById('rule-id').value = rule.rule_id;
            document.getElementById('rule-name').value = rule.rule_name;
            document.getElementById('alarm-id').value = rule.alarm_id || '';
            document.getElementById('room-id').value = rule.room_id || '';
            document.getElementById('trigger-condition').value = rule.trigger_condition;
            document.getElementById('condition-value').value = rule.condition_value || '';
            document.getElementById('action-type').value = rule.action_type;
            document.getElementById('action-target').value = rule.action_target || '';
            document.getElementById('action-params').value = JSON.stringify(rule.action_params || {}, null, 2);
            document.getElementById('priority').value = rule.priority || 0;
            document.getElementById('enabled').checked = rule.enabled;

            document.getElementById('rule-modal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('rule-modal').style.display = 'none';
        }

        // æäº¤è§„åˆ™
        async function submitRule(event) {
            event.preventDefault();

            const ruleId = document.getElementById('rule-id').value;
            const formData = {
                rule_name: document.getElementById('rule-name').value,
                alarm_id: document.getElementById('alarm-id').value || null,
                room_id: document.getElementById('room-id').value || null,
                trigger_condition: document.getElementById('trigger-condition').value,
                condition_value: parseFloat(document.getElementById('condition-value').value) || null,
                action_type: document.getElementById('action-type').value,
                action_target: document.getElementById('action-target').value || null,
                priority: parseInt(document.getElementById('priority').value),
                enabled: document.getElementById('enabled').checked
            };

            // è§£æJSONå‚æ•°
            try {
                const paramsText = document.getElementById('action-params').value;
                if (paramsText.trim()) {
                    formData.action_params = JSON.parse(paramsText);
                }
            } catch (e) {
                alert('åŠ¨ä½œå‚æ•°JSONæ ¼å¼é”™è¯¯');
                return;
            }

            try {
                const url = ruleId ?
                    `${API_BASE}/automation/rules/${ruleId}` :
                    `${API_BASE}/automation/rules`;
                const method = ruleId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(ruleId ? 'è§„åˆ™æ›´æ–°æˆåŠŸ' : 'è§„åˆ™åˆ›å»ºæˆåŠŸ');
                    closeModal();
                    await loadRules();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æäº¤è§„åˆ™å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢è§„åˆ™çŠ¶æ€
        async function toggleRule(ruleId, enabled) {
            try {
                const response = await fetch(`${API_BASE}/automation/rules/${ruleId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled: enabled })
                });

                const data = await response.json();

                if (data.success) {
                    await loadRules();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ‡æ¢è§„åˆ™çŠ¶æ€å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // åˆ é™¤è§„åˆ™
        async function deleteRule(ruleId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è§„åˆ™å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/automation/rules/${ruleId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('è§„åˆ™åˆ é™¤æˆåŠŸ');
                    await loadRules();
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ é™¤è§„åˆ™å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥');
            }
        }

        // æ›´æ–°æ¡ä»¶å€¼æç¤º
        function updateConditionValueHint() {
            const condition = document.getElementById('trigger-condition').value;
            const hints = {
                'alarm_triggered': 'å¯¹äºæŠ¥è­¦è§¦å‘ï¼Œä½¿ç”¨ 1',
                'smoke_level_threshold': 'çƒŸé›¾æµ“åº¦ç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ 50.0',
                'battery_low': 'ç”µæ± ç”µé‡ç™¾åˆ†æ¯”ï¼Œä¾‹å¦‚ 20',
                'test_mode_activated': 'å¯¹äºæµ‹è¯•æ¨¡å¼ï¼Œä½¿ç”¨ 1'
            };
            document.getElementById('condition-value-hint').textContent = hints[condition] || '';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('rule-modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
