<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报警监控仪表板 - NIS3351智慧家居</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        nav {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        nav a:hover {
            opacity: 0.8;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .panel-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .status-card.normal {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .status-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .status-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            animation: pulse-danger 2s infinite;
        }

        @keyframes pulse-danger {
            0%, 100% {
                box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);
            }
            50% {
                box-shadow: 0 0 40px rgba(220, 53, 69, 1);
            }
        }

        .status-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 0.95em;
            opacity: 0.95;
        }

        .alarm-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .alarm-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #28a745;
            transition: all 0.3s;
        }

        .alarm-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .alarm-item.alarm-active {
            background: #fee;
            border-left-color: #dc3545;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .alarm-item.low-battery {
            border-left-color: #ffc107;
        }

        .alarm-item.test-mode {
            border-left-color: #17a2b8;
        }

        .alarm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .alarm-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .alarm-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-normal {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .alarm-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .detail-item {
            font-size: 0.9em;
            color: #666;
        }

        .detail-item strong {
            color: #333;
        }

        .smoke-bar {
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
        }

        .smoke-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 15px;
            border-left: 3px solid #007bff;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .activity-item.ALARM_TRIGGERED {
            border-left-color: #dc3545;
        }

        .activity-item.ALARM_CLEARED {
            border-left-color: #28a745;
        }

        .activity-item.LOW_BATTERY {
            border-left-color: #ffc107;
        }

        .activity-time {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }

        .activity-text {
            color: #333;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 10px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .map-view {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .map-placeholder {
            font-size: 5em;
            color: #ddd;
            margin-bottom: 20px;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .room-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .room-card.has-alarm {
            border-color: #dc3545;
            background: #fee;
        }

        .room-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .room-name {
            font-weight: bold;
            color: #333;
        }

        .room-status {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 9999;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        .notification-toast.show {
            display: block;
        }

        .last-update {
            font-size: 0.85em;
            color: #666;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">首页</a>
            <a href="smoke-alarm.html">烟雾报警器</a>
            <a href="alarm-dashboard.html" style="font-weight: bold;">报警仪表板</a>
            <a href="alarm-statistics.html">统计分析</a>
            <a href="device-maintenance.html">设备维护</a>
            <a href="automation-rules.html">自动化规则</a>
            <a href="room-management.html">房间管理</a>
        </nav>

        <header>
            <h1>🚨 报警监控仪表板</h1>
            <p>实时监控所有烟雾报警器状态
                <span class="refresh-indicator"></span>
            </p>
            <p class="last-update">最后更新: <span id="last-update-time">--</span></p>
        </header>

        <!-- 状态总览 -->
        <div class="panel">
            <h2 class="panel-title">系统状态总览</h2>
            <div class="status-overview">
                <div class="status-card normal">
                    <div class="status-number" id="normal-count">0</div>
                    <div class="status-label">✓ 正常</div>
                </div>
                <div class="status-card warning">
                    <div class="status-number" id="warning-count">0</div>
                    <div class="status-label">⚠ 警告</div>
                </div>
                <div class="status-card danger">
                    <div class="status-number" id="danger-count">0</div>
                    <div class="status-label">🔥 报警</div>
                </div>
                <div class="status-card normal" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);">
                    <div class="status-number" id="total-count">0</div>
                    <div class="status-label">📊 设备总数</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- 设备列表 -->
            <div class="panel">
                <h2 class="panel-title">
                    设备监控
                    <button class="btn btn-primary btn-sm" onclick="refreshData()">🔄 刷新</button>
                </h2>

                <div class="filters">
                    <button class="filter-btn active" data-filter="all" onclick="filterAlarms('all')">全部</button>
                    <button class="filter-btn" data-filter="alarm" onclick="filterAlarms('alarm')">🔥 报警中</button>
                    <button class="filter-btn" data-filter="warning" onclick="filterAlarms('warning')">⚠ 警告</button>
                    <button class="filter-btn" data-filter="normal" onclick="filterAlarms('normal')">✓ 正常</button>
                </div>

                <div id="loading" class="loading">正在加载数据...</div>
                <div id="alarm-list" class="alarm-list" style="display: none;"></div>
            </div>

            <!-- 活动动态 -->
            <div class="panel">
                <h2 class="panel-title">实时活动</h2>
                <div id="activity-feed" class="activity-feed">
                    <div class="loading">正在加载活动...</div>
                </div>
            </div>
        </div>

        <!-- 房间视图 -->
        <div class="panel">
            <h2 class="panel-title">房间视图</h2>
            <div id="room-grid" class="room-grid">
                <div class="loading">正在加载房间...</div>
            </div>
        </div>
    </div>

    <!-- 报警通知Toast -->
    <div id="notification-toast" class="notification-toast">
        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
            🚨 报警警告！
        </div>
        <div id="notification-text"></div>
    </div>

    <!-- Socket.IO 客户端库 -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        const API_BASE = 'http://localhost:5000';
        let allAlarms = [];
        let allEvents = [];
        let allRooms = [];
        let currentFilter = 'all';
        let refreshInterval;
        let socket;

        // 页面加载时初始化
        window.onload = async function() {
            await refreshData();
            // 初始化WebSocket连接
            initWebSocket();
            // 每30秒自动刷新一次（WebSocket会实时更新，减少轮询频率）
            refreshInterval = setInterval(refreshData, 30000);
        };

        // 初始化WebSocket连接
        function initWebSocket() {
            try {
                socket = io(API_BASE, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 5
                });

                socket.on('connect', () => {
                    console.log('✓ WebSocket 已连接');
                    updateLastUpdateTime();
                });

                socket.on('disconnect', () => {
                    console.log('✗ WebSocket 已断开');
                });

                // 监听烟雾报警器状态更新
                socket.on('smoke_alarm_state_update', (data) => {
                    console.log('📨 收到烟雾报警器状态更新:', data);
                    handleSmokeAlarmUpdate(data);
                });

                // 监听烟雾报警器事件（高优先级通知）
                socket.on('smoke_alarm_event', (data) => {
                    console.log('🚨 收到烟雾报警器事件:', data);
                    handleSmokeAlarmEvent(data);
                });

                socket.on('connect_error', (error) => {
                    console.error('WebSocket 连接错误:', error);
                });
            } catch (error) {
                console.error('初始化WebSocket失败:', error);
            }
        }

        // 处理烟雾报警器状态更新
        function handleSmokeAlarmUpdate(data) {
            // 更新本地数据
            const index = allAlarms.findIndex(a => a.alarm_id === data.alarm_id);
            if (index !== -1) {
                allAlarms[index] = {
                    ...allAlarms[index],
                    smoke_level: data.smoke_level,
                    alarm_triggered: data.alarm_active,
                    battery_level: data.battery,
                    test_mode: data.test_mode,
                    sensitivity: data.sensitivity,
                    last_updated: new Date().toISOString()
                };
            } else {
                // 新设备，添加到列表
                allAlarms.push({
                    alarm_id: data.alarm_id,
                    location: data.location,
                    smoke_level: data.smoke_level,
                    alarm_triggered: data.alarm_active,
                    battery_level: data.battery,
                    test_mode: data.test_mode,
                    sensitivity: data.sensitivity,
                    last_updated: new Date().toISOString()
                });
            }

            // 刷新显示
            filterAlarms(currentFilter);
            updateStatusCards();
            updateLastUpdateTime();

            // 如果是报警触发，显示通知
            if (data.alarm_active) {
                showNotification(`${data.alarm_id} 检测到烟雾！浓度: ${data.smoke_level}%`);
                // 播放声音提示（可选）
                playAlertSound();
            }
        }

        // 处理烟雾报警器事件
        function handleSmokeAlarmEvent(data) {
            // 添加到事件列表顶部
            allEvents.unshift({
                alarm_id: data.alarm_id,
                event_type: data.event_type,
                smoke_level: data.smoke_level,
                detail: data.detail,
                timestamp: new Date().toISOString()
            });

            // 限制事件列表长度
            if (allEvents.length > 50) {
                allEvents = allEvents.slice(0, 50);
            }

            // 刷新活动动态
            displayActivity(allEvents);

            // 高优先级事件通知
            if (data.priority === 'high') {
                showNotification(`🚨 紧急：${data.alarm_id} - ${getEventText(data.event_type)}`);
                playAlertSound();
            }
        }

        // 播放报警声音
        function playAlertSound() {
            // 创建音频上下文播放提示音
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('无法播放声音:', error);
            }
        }

        // 刷新数据
        async function refreshData() {
            await Promise.all([
                loadAlarms(),
                loadEvents(),
                loadRooms()
            ]);
            updateLastUpdateTime();
        }

        // 加载烟雾报警器
        async function loadAlarms() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms`);
                allAlarms = await response.json();

                filterAlarms(currentFilter);
                updateStatusCards();
            } catch (error) {
                console.error('加载报警器失败:', error);
            }
        }

        // 筛选显示报警器
        function filterAlarms(filter) {
            currentFilter = filter;

            // 更新筛选按钮
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });

            let filtered = allAlarms;

            if (filter === 'alarm') {
                filtered = allAlarms.filter(a => a.alarm_triggered);
            } else if (filter === 'warning') {
                filtered = allAlarms.filter(a => !a.alarm_triggered && (a.battery_level < 20 || a.smoke_level > 30));
            } else if (filter === 'normal') {
                filtered = allAlarms.filter(a => !a.alarm_triggered && a.battery_level >= 20 && a.smoke_level <= 30);
            }

            displayAlarms(filtered);
        }

        // 显示报警器列表
        function displayAlarms(alarms) {
            const listContainer = document.getElementById('alarm-list');
            listContainer.innerHTML = '';

            if (alarms.length === 0) {
                listContainer.innerHTML = '<div class="loading">无匹配的设备</div>';
                listContainer.style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            listContainer.style.display = 'block';
            document.getElementById('loading').style.display = 'none';

            alarms.forEach(alarm => {
                const item = document.createElement('div');
                let itemClass = 'alarm-item';
                let badgeClass = 'badge-normal';
                let badgeText = '正常';

                if (alarm.alarm_triggered) {
                    itemClass += ' alarm-active';
                    badgeClass = 'badge-danger';
                    badgeText = '🔥 报警中';
                } else if (alarm.battery_level < 20) {
                    itemClass += ' low-battery';
                    badgeClass = 'badge-warning';
                    badgeText = '⚠ 低电量';
                } else if (alarm.test_mode) {
                    itemClass += ' test-mode';
                    badgeClass = 'badge-normal';
                    badgeText = '🔍 测试模式';
                }

                item.className = itemClass;
                item.innerHTML = `
                    <div class="alarm-header">
                        <div class="alarm-name">${alarm.alarm_id}</div>
                        <div class="alarm-badge ${badgeClass}">${badgeText}</div>
                    </div>
                    <div class="alarm-details">
                        <div class="detail-item">
                            <strong>位置:</strong> ${alarm.location || '未知'}
                        </div>
                        <div class="detail-item">
                            <strong>电池:</strong> ${alarm.battery_level}%
                        </div>
                        <div class="detail-item">
                            <strong>灵敏度:</strong> ${alarm.sensitivity || 'medium'}
                        </div>
                        <div class="detail-item">
                            <strong>最后更新:</strong> ${formatTime(alarm.last_updated)}
                        </div>
                    </div>
                    <div class="smoke-bar">
                        <div class="smoke-bar-fill" style="width: ${Math.min(alarm.smoke_level, 100)}%">
                            烟雾: ${alarm.smoke_level.toFixed(1)}%
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewDetails('${alarm.alarm_id}')">
                            查看详情
                        </button>
                        ${alarm.alarm_triggered ? `
                            <button class="btn btn-success btn-sm" onclick="acknowledgeAlarm('${alarm.alarm_id}')">
                                确认报警
                            </button>
                        ` : ''}
                        <button class="btn btn-warning btn-sm" onclick="testDevice('${alarm.alarm_id}')">
                            测试设备
                        </button>
                    </div>
                `;

                listContainer.appendChild(item);
            });
        }

        // 更新状态卡片
        function updateStatusCards() {
            const normal = allAlarms.filter(a => !a.alarm_triggered && a.battery_level >= 20).length;
            const warning = allAlarms.filter(a => !a.alarm_triggered && (a.battery_level < 20 || a.smoke_level > 30)).length;
            const danger = allAlarms.filter(a => a.alarm_triggered).length;

            document.getElementById('normal-count').textContent = normal;
            document.getElementById('warning-count').textContent = warning;
            document.getElementById('danger-count').textContent = danger;
            document.getElementById('total-count').textContent = allAlarms.length;

            // 如果有新的报警，显示通知
            if (danger > 0) {
                const alarmDevices = allAlarms.filter(a => a.alarm_triggered).map(a => a.alarm_id).join(', ');
                showNotification(`检测到报警: ${alarmDevices}`);
            }
        }

        // 加载活动事件
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/events?limit=20`);
                const data = await response.json();
                allEvents = data.events || [];

                displayActivity(allEvents);
            } catch (error) {
                console.error('加载事件失败:', error);
            }
        }

        // 显示活动动态
        function displayActivity(events) {
            const feedContainer = document.getElementById('activity-feed');
            feedContainer.innerHTML = '';

            if (events.length === 0) {
                feedContainer.innerHTML = '<div class="loading">暂无活动记录</div>';
                return;
            }

            events.forEach(event => {
                const item = document.createElement('div');
                item.className = `activity-item ${event.event_type}`;
                item.innerHTML = `
                    <div class="activity-time">${formatDateTime(event.timestamp)}</div>
                    <div class="activity-text">
                        ${getEventIcon(event.event_type)} <strong>${event.alarm_id}</strong> - ${getEventText(event.event_type)}
                        ${event.detail ? `<br><small>${event.detail}</small>` : ''}
                    </div>
                `;
                feedContainer.appendChild(item);
            });
        }

        // 加载房间
        async function loadRooms() {
            try {
                const response = await fetch(`${API_BASE}/rooms`);
                const data = await response.json();
                allRooms = data.rooms || [];

                displayRooms();
            } catch (error) {
                console.error('加载房间失败:', error);
                document.getElementById('room-grid').innerHTML = '<div class="loading">暂无房间数据</div>';
            }
        }

        // 显示房间
        function displayRooms() {
            const gridContainer = document.getElementById('room-grid');
            gridContainer.innerHTML = '';

            if (allRooms.length === 0) {
                gridContainer.innerHTML = '<div class="loading">暂无房间配置</div>';
                return;
            }

            allRooms.forEach(room => {
                const alarms = allAlarms.filter(a => a.room_id === room.room_id);
                const hasAlarm = alarms.some(a => a.alarm_triggered);

                const card = document.createElement('div');
                card.className = `room-card ${hasAlarm ? 'has-alarm' : ''}`;
                card.onclick = () => filterByRoom(room.room_id);

                card.innerHTML = `
                    <div class="room-icon">${hasAlarm ? '🔥' : '🏠'}</div>
                    <div class="room-name">${room.room_name}</div>
                    <div class="room-status">
                        ${alarms.length} 个设备
                        ${hasAlarm ? '<br>⚠ 有报警' : ''}
                    </div>
                `;

                gridContainer.appendChild(card);
            });
        }

        // 按房间筛选
        function filterByRoom(roomId) {
            const filtered = allAlarms.filter(a => a.room_id === roomId);
            displayAlarms(filtered);
            currentFilter = 'room';
        }

        // 查看详情
        function viewDetails(alarmId) {
            window.location.href = `smoke-alarm.html?alarm=${alarmId}`;
        }

        // 确认报警
        async function acknowledgeAlarm(alarmId) {
            const acknowledgedBy = prompt('请输入确认人姓名:');
            if (!acknowledgedBy) return;

            const notes = prompt('请输入处理备注（可选）:') || '';

            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/${alarmId}/acknowledge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        acknowledged_by: acknowledgedBy,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.status === 'success' || data.success) {
                    alert('报警已确认');
                    await refreshData();
                } else {
                    alert('操作失败: ' + (data.error || '未知错误'));
                }
            } catch (error) {
                console.error('确认报警失败:', error);
                alert('操作失败');
            }
        }

        // 测试设备
        async function testDevice(alarmId) {
            if (!confirm(`确定要启动 ${alarmId} 的测试模式吗？`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/${alarmId}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test_mode: true })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('测试模式已启动');
                    await refreshData();
                } else {
                    alert('操作失败');
                }
            } catch (error) {
                console.error('测试设备失败:', error);
                alert('操作失败');
            }
        }

        // 显示通知
        function showNotification(text) {
            const toast = document.getElementById('notification-toast');
            document.getElementById('notification-text').textContent = text;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // 更新最后更新时间
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString('zh-CN');
        }

        // 获取事件图标
        function getEventIcon(eventType) {
            const icons = {
                'ALARM_TRIGGERED': '🔥',
                'ALARM_CLEARED': '✅',
                'LOW_BATTERY': '🔋',
                'TEST_STARTED': '🔍',
                'TEST_STOPPED': '⏹',
                'SENSITIVITY_CHANGED': '⚙️'
            };
            return icons[eventType] || '📝';
        }

        // 获取事件文本
        function getEventText(eventType) {
            const texts = {
                'ALARM_TRIGGERED': '报警触发',
                'ALARM_CLEARED': '报警清除',
                'LOW_BATTERY': '电池电量低',
                'TEST_STARTED': '测试模式启动',
                'TEST_STOPPED': '测试模式停止',
                'SENSITIVITY_CHANGED': '灵敏度已更改'
            };
            return texts[eventType] || eventType;
        }

        // 格式化时间
        function formatTime(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // 格式化日期时间
        function formatDateTime(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = (now - date) / 1000; // 秒

            if (diff < 60) {
                return '刚刚';
            } else if (diff < 3600) {
                return `${Math.floor(diff / 60)} 分钟前`;
            } else if (diff < 86400) {
                return `${Math.floor(diff / 3600)} 小时前`;
            } else {
                return date.toLocaleString('zh-CN');
            }
        }

        // 页面卸载时清除定时器和断开WebSocket
        window.onbeforeunload = function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (socket) {
                socket.disconnect();
                console.log('WebSocket 已断开');
            }
        };
    </script>
</body>
</html>
