<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥è­¦ç›‘æ§ä»ªè¡¨æ¿ - NIS3351æ™ºæ…§å®¶å±…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        nav {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        nav a:hover {
            opacity: 0.8;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .panel-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .status-card.normal {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .status-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }

        .status-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            animation: pulse-danger 2s infinite;
        }

        @keyframes pulse-danger {
            0%, 100% {
                box-shadow: 0 0 20px rgba(220, 53, 69, 0.5);
            }
            50% {
                box-shadow: 0 0 40px rgba(220, 53, 69, 1);
            }
        }

        .status-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-label {
            font-size: 0.95em;
            opacity: 0.95;
        }

        .alarm-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .alarm-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #28a745;
            transition: all 0.3s;
        }

        .alarm-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .alarm-item.alarm-active {
            background: #fee;
            border-left-color: #dc3545;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .alarm-item.low-battery {
            border-left-color: #ffc107;
        }

        .alarm-item.test-mode {
            border-left-color: #17a2b8;
        }

        .alarm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .alarm-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .alarm-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-normal {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #333;
        }

        .badge-danger {
            background: #dc3545;
            color: white;
        }

        .alarm-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .detail-item {
            font-size: 0.9em;
            color: #666;
        }

        .detail-item strong {
            color: #333;
        }

        .smoke-bar {
            height: 25px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
        }

        .smoke-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: bold;
            color: white;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 15px;
            border-left: 3px solid #007bff;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .activity-item.ALARM_TRIGGERED {
            border-left-color: #dc3545;
        }

        .activity-item.ALARM_CLEARED {
            border-left-color: #28a745;
        }

        .activity-item.LOW_BATTERY {
            border-left-color: #ffc107;
        }

        .activity-time {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }

        .activity-text {
            color: #333;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .refresh-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 10px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .map-view {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .map-placeholder {
            font-size: 5em;
            color: #ddd;
            margin-bottom: 20px;
        }

        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .room-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .room-card.has-alarm {
            border-color: #dc3545;
            background: #fee;
        }

        .room-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .room-name {
            font-weight: bold;
            color: #333;
        }

        .room-status {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 9999;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        .notification-toast.show {
            display: block;
        }

        .last-update {
            font-size: 0.85em;
            color: #666;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">é¦–é¡µ</a>
            <a href="smoke-alarm.html">çƒŸé›¾æŠ¥è­¦å™¨</a>
            <a href="alarm-dashboard.html" style="font-weight: bold;">æŠ¥è­¦ä»ªè¡¨æ¿</a>
            <a href="alarm-statistics.html">ç»Ÿè®¡åˆ†æ</a>
            <a href="device-maintenance.html">è®¾å¤‡ç»´æŠ¤</a>
            <a href="automation-rules.html">è‡ªåŠ¨åŒ–è§„åˆ™</a>
            <a href="room-management.html">æˆ¿é—´ç®¡ç†</a>
        </nav>

        <header>
            <h1>ğŸš¨ æŠ¥è­¦ç›‘æ§ä»ªè¡¨æ¿</h1>
            <p>å®æ—¶ç›‘æ§æ‰€æœ‰çƒŸé›¾æŠ¥è­¦å™¨çŠ¶æ€
                <span class="refresh-indicator"></span>
            </p>
            <p class="last-update">æœ€åæ›´æ–°: <span id="last-update-time">--</span></p>
        </header>

        <!-- çŠ¶æ€æ€»è§ˆ -->
        <div class="panel">
            <h2 class="panel-title">ç³»ç»ŸçŠ¶æ€æ€»è§ˆ</h2>
            <div class="status-overview">
                <div class="status-card normal">
                    <div class="status-number" id="normal-count">0</div>
                    <div class="status-label">âœ“ æ­£å¸¸</div>
                </div>
                <div class="status-card warning">
                    <div class="status-number" id="warning-count">0</div>
                    <div class="status-label">âš  è­¦å‘Š</div>
                </div>
                <div class="status-card danger">
                    <div class="status-number" id="danger-count">0</div>
                    <div class="status-label">ğŸ”¥ æŠ¥è­¦</div>
                </div>
                <div class="status-card normal" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);">
                    <div class="status-number" id="total-count">0</div>
                    <div class="status-label">ğŸ“Š è®¾å¤‡æ€»æ•°</div>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- è®¾å¤‡åˆ—è¡¨ -->
            <div class="panel">
                <h2 class="panel-title">
                    è®¾å¤‡ç›‘æ§
                    <button class="btn btn-primary btn-sm" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
                </h2>

                <div class="filters">
                    <button class="filter-btn active" data-filter="all" onclick="filterAlarms('all')">å…¨éƒ¨</button>
                    <button class="filter-btn" data-filter="alarm" onclick="filterAlarms('alarm')">ğŸ”¥ æŠ¥è­¦ä¸­</button>
                    <button class="filter-btn" data-filter="warning" onclick="filterAlarms('warning')">âš  è­¦å‘Š</button>
                    <button class="filter-btn" data-filter="normal" onclick="filterAlarms('normal')">âœ“ æ­£å¸¸</button>
                </div>

                <div id="loading" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
                <div id="alarm-list" class="alarm-list" style="display: none;"></div>
            </div>

            <!-- æ´»åŠ¨åŠ¨æ€ -->
            <div class="panel">
                <h2 class="panel-title">å®æ—¶æ´»åŠ¨</h2>
                <div id="activity-feed" class="activity-feed">
                    <div class="loading">æ­£åœ¨åŠ è½½æ´»åŠ¨...</div>
                </div>
            </div>
        </div>

        <!-- æˆ¿é—´è§†å›¾ -->
        <div class="panel">
            <h2 class="panel-title">æˆ¿é—´è§†å›¾</h2>
            <div id="room-grid" class="room-grid">
                <div class="loading">æ­£åœ¨åŠ è½½æˆ¿é—´...</div>
            </div>
        </div>
    </div>

    <!-- æŠ¥è­¦é€šçŸ¥Toast -->
    <div id="notification-toast" class="notification-toast">
        <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
            ğŸš¨ æŠ¥è­¦è­¦å‘Šï¼
        </div>
        <div id="notification-text"></div>
    </div>

    <!-- Socket.IO å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
        const API_BASE = 'http://localhost:5000';
        let allAlarms = [];
        let allEvents = [];
        let allRooms = [];
        let currentFilter = 'all';
        let refreshInterval;
        let socket;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            await refreshData();
            // åˆå§‹åŒ–WebSocketè¿æ¥
            initWebSocket();
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ï¼ˆWebSocketä¼šå®æ—¶æ›´æ–°ï¼Œå‡å°‘è½®è¯¢é¢‘ç‡ï¼‰
            refreshInterval = setInterval(refreshData, 30000);
        };

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            try {
                socket = io(API_BASE, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 5
                });

                socket.on('connect', () => {
                    console.log('âœ“ WebSocket å·²è¿æ¥');
                    updateLastUpdateTime();
                });

                socket.on('disconnect', () => {
                    console.log('âœ— WebSocket å·²æ–­å¼€');
                });

                // ç›‘å¬çƒŸé›¾æŠ¥è­¦å™¨çŠ¶æ€æ›´æ–°
                socket.on('smoke_alarm_state_update', (data) => {
                    console.log('ğŸ“¨ æ”¶åˆ°çƒŸé›¾æŠ¥è­¦å™¨çŠ¶æ€æ›´æ–°:', data);
                    handleSmokeAlarmUpdate(data);
                });

                // ç›‘å¬çƒŸé›¾æŠ¥è­¦å™¨äº‹ä»¶ï¼ˆé«˜ä¼˜å…ˆçº§é€šçŸ¥ï¼‰
                socket.on('smoke_alarm_event', (data) => {
                    console.log('ğŸš¨ æ”¶åˆ°çƒŸé›¾æŠ¥è­¦å™¨äº‹ä»¶:', data);
                    handleSmokeAlarmEvent(data);
                });

                socket.on('connect_error', (error) => {
                    console.error('WebSocket è¿æ¥é”™è¯¯:', error);
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–WebSocketå¤±è´¥:', error);
            }
        }

        // å¤„ç†çƒŸé›¾æŠ¥è­¦å™¨çŠ¶æ€æ›´æ–°
        function handleSmokeAlarmUpdate(data) {
            // æ›´æ–°æœ¬åœ°æ•°æ®
            const index = allAlarms.findIndex(a => a.alarm_id === data.alarm_id);
            if (index !== -1) {
                allAlarms[index] = {
                    ...allAlarms[index],
                    smoke_level: data.smoke_level,
                    alarm_triggered: data.alarm_active,
                    battery_level: data.battery,
                    test_mode: data.test_mode,
                    sensitivity: data.sensitivity,
                    last_updated: new Date().toISOString()
                };
            } else {
                // æ–°è®¾å¤‡ï¼Œæ·»åŠ åˆ°åˆ—è¡¨
                allAlarms.push({
                    alarm_id: data.alarm_id,
                    location: data.location,
                    smoke_level: data.smoke_level,
                    alarm_triggered: data.alarm_active,
                    battery_level: data.battery,
                    test_mode: data.test_mode,
                    sensitivity: data.sensitivity,
                    last_updated: new Date().toISOString()
                });
            }

            // åˆ·æ–°æ˜¾ç¤º
            filterAlarms(currentFilter);
            updateStatusCards();
            updateLastUpdateTime();

            // å¦‚æœæ˜¯æŠ¥è­¦è§¦å‘ï¼Œæ˜¾ç¤ºé€šçŸ¥
            if (data.alarm_active) {
                showNotification(`${data.alarm_id} æ£€æµ‹åˆ°çƒŸé›¾ï¼æµ“åº¦: ${data.smoke_level}%`);
                // æ’­æ”¾å£°éŸ³æç¤ºï¼ˆå¯é€‰ï¼‰
                playAlertSound();
            }
        }

        // å¤„ç†çƒŸé›¾æŠ¥è­¦å™¨äº‹ä»¶
        function handleSmokeAlarmEvent(data) {
            // æ·»åŠ åˆ°äº‹ä»¶åˆ—è¡¨é¡¶éƒ¨
            allEvents.unshift({
                alarm_id: data.alarm_id,
                event_type: data.event_type,
                smoke_level: data.smoke_level,
                detail: data.detail,
                timestamp: new Date().toISOString()
            });

            // é™åˆ¶äº‹ä»¶åˆ—è¡¨é•¿åº¦
            if (allEvents.length > 50) {
                allEvents = allEvents.slice(0, 50);
            }

            // åˆ·æ–°æ´»åŠ¨åŠ¨æ€
            displayActivity(allEvents);

            // é«˜ä¼˜å…ˆçº§äº‹ä»¶é€šçŸ¥
            if (data.priority === 'high') {
                showNotification(`ğŸš¨ ç´§æ€¥ï¼š${data.alarm_id} - ${getEventText(data.event_type)}`);
                playAlertSound();
            }
        }

        // æ’­æ”¾æŠ¥è­¦å£°éŸ³
        function playAlertSound() {
            // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡æ’­æ”¾æç¤ºéŸ³
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.log('æ— æ³•æ’­æ”¾å£°éŸ³:', error);
            }
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            await Promise.all([
                loadAlarms(),
                loadEvents(),
                loadRooms()
            ]);
            updateLastUpdateTime();
        }

        // åŠ è½½çƒŸé›¾æŠ¥è­¦å™¨
        async function loadAlarms() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms`);
                allAlarms = await response.json();

                filterAlarms(currentFilter);
                updateStatusCards();
            } catch (error) {
                console.error('åŠ è½½æŠ¥è­¦å™¨å¤±è´¥:', error);
            }
        }

        // ç­›é€‰æ˜¾ç¤ºæŠ¥è­¦å™¨
        function filterAlarms(filter) {
            currentFilter = filter;

            // æ›´æ–°ç­›é€‰æŒ‰é’®
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                }
            });

            let filtered = allAlarms;

            if (filter === 'alarm') {
                filtered = allAlarms.filter(a => a.alarm_triggered);
            } else if (filter === 'warning') {
                filtered = allAlarms.filter(a => !a.alarm_triggered && (a.battery_level < 20 || a.smoke_level > 30));
            } else if (filter === 'normal') {
                filtered = allAlarms.filter(a => !a.alarm_triggered && a.battery_level >= 20 && a.smoke_level <= 30);
            }

            displayAlarms(filtered);
        }

        // æ˜¾ç¤ºæŠ¥è­¦å™¨åˆ—è¡¨
        function displayAlarms(alarms) {
            const listContainer = document.getElementById('alarm-list');
            listContainer.innerHTML = '';

            if (alarms.length === 0) {
                listContainer.innerHTML = '<div class="loading">æ— åŒ¹é…çš„è®¾å¤‡</div>';
                listContainer.style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            listContainer.style.display = 'block';
            document.getElementById('loading').style.display = 'none';

            alarms.forEach(alarm => {
                const item = document.createElement('div');
                let itemClass = 'alarm-item';
                let badgeClass = 'badge-normal';
                let badgeText = 'æ­£å¸¸';

                if (alarm.alarm_triggered) {
                    itemClass += ' alarm-active';
                    badgeClass = 'badge-danger';
                    badgeText = 'ğŸ”¥ æŠ¥è­¦ä¸­';
                } else if (alarm.battery_level < 20) {
                    itemClass += ' low-battery';
                    badgeClass = 'badge-warning';
                    badgeText = 'âš  ä½ç”µé‡';
                } else if (alarm.test_mode) {
                    itemClass += ' test-mode';
                    badgeClass = 'badge-normal';
                    badgeText = 'ğŸ” æµ‹è¯•æ¨¡å¼';
                }

                item.className = itemClass;
                item.innerHTML = `
                    <div class="alarm-header">
                        <div class="alarm-name">${alarm.alarm_id}</div>
                        <div class="alarm-badge ${badgeClass}">${badgeText}</div>
                    </div>
                    <div class="alarm-details">
                        <div class="detail-item">
                            <strong>ä½ç½®:</strong> ${alarm.location || 'æœªçŸ¥'}
                        </div>
                        <div class="detail-item">
                            <strong>ç”µæ± :</strong> ${alarm.battery_level}%
                        </div>
                        <div class="detail-item">
                            <strong>çµæ•åº¦:</strong> ${alarm.sensitivity || 'medium'}
                        </div>
                        <div class="detail-item">
                            <strong>æœ€åæ›´æ–°:</strong> ${formatTime(alarm.last_updated)}
                        </div>
                    </div>
                    <div class="smoke-bar">
                        <div class="smoke-bar-fill" style="width: ${Math.min(alarm.smoke_level, 100)}%">
                            çƒŸé›¾: ${alarm.smoke_level.toFixed(1)}%
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewDetails('${alarm.alarm_id}')">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        ${alarm.alarm_triggered ? `
                            <button class="btn btn-success btn-sm" onclick="acknowledgeAlarm('${alarm.alarm_id}')">
                                ç¡®è®¤æŠ¥è­¦
                            </button>
                        ` : ''}
                        <button class="btn btn-warning btn-sm" onclick="testDevice('${alarm.alarm_id}')">
                            æµ‹è¯•è®¾å¤‡
                        </button>
                    </div>
                `;

                listContainer.appendChild(item);
            });
        }

        // æ›´æ–°çŠ¶æ€å¡ç‰‡
        function updateStatusCards() {
            const normal = allAlarms.filter(a => !a.alarm_triggered && a.battery_level >= 20).length;
            const warning = allAlarms.filter(a => !a.alarm_triggered && (a.battery_level < 20 || a.smoke_level > 30)).length;
            const danger = allAlarms.filter(a => a.alarm_triggered).length;

            document.getElementById('normal-count').textContent = normal;
            document.getElementById('warning-count').textContent = warning;
            document.getElementById('danger-count').textContent = danger;
            document.getElementById('total-count').textContent = allAlarms.length;

            // å¦‚æœæœ‰æ–°çš„æŠ¥è­¦ï¼Œæ˜¾ç¤ºé€šçŸ¥
            if (danger > 0) {
                const alarmDevices = allAlarms.filter(a => a.alarm_triggered).map(a => a.alarm_id).join(', ');
                showNotification(`æ£€æµ‹åˆ°æŠ¥è­¦: ${alarmDevices}`);
            }
        }

        // åŠ è½½æ´»åŠ¨äº‹ä»¶
        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/events?limit=20`);
                const data = await response.json();
                allEvents = data.events || [];

                displayActivity(allEvents);
            } catch (error) {
                console.error('åŠ è½½äº‹ä»¶å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ´»åŠ¨åŠ¨æ€
        function displayActivity(events) {
            const feedContainer = document.getElementById('activity-feed');
            feedContainer.innerHTML = '';

            if (events.length === 0) {
                feedContainer.innerHTML = '<div class="loading">æš‚æ— æ´»åŠ¨è®°å½•</div>';
                return;
            }

            events.forEach(event => {
                const item = document.createElement('div');
                item.className = `activity-item ${event.event_type}`;
                item.innerHTML = `
                    <div class="activity-time">${formatDateTime(event.timestamp)}</div>
                    <div class="activity-text">
                        ${getEventIcon(event.event_type)} <strong>${event.alarm_id}</strong> - ${getEventText(event.event_type)}
                        ${event.detail ? `<br><small>${event.detail}</small>` : ''}
                    </div>
                `;
                feedContainer.appendChild(item);
            });
        }

        // åŠ è½½æˆ¿é—´
        async function loadRooms() {
            try {
                const response = await fetch(`${API_BASE}/rooms`);
                const data = await response.json();
                allRooms = data.rooms || [];

                displayRooms();
            } catch (error) {
                console.error('åŠ è½½æˆ¿é—´å¤±è´¥:', error);
                document.getElementById('room-grid').innerHTML = '<div class="loading">æš‚æ— æˆ¿é—´æ•°æ®</div>';
            }
        }

        // æ˜¾ç¤ºæˆ¿é—´
        function displayRooms() {
            const gridContainer = document.getElementById('room-grid');
            gridContainer.innerHTML = '';

            if (allRooms.length === 0) {
                gridContainer.innerHTML = '<div class="loading">æš‚æ— æˆ¿é—´é…ç½®</div>';
                return;
            }

            allRooms.forEach(room => {
                const alarms = allAlarms.filter(a => a.room_id === room.room_id);
                const hasAlarm = alarms.some(a => a.alarm_triggered);

                const card = document.createElement('div');
                card.className = `room-card ${hasAlarm ? 'has-alarm' : ''}`;
                card.onclick = () => filterByRoom(room.room_id);

                card.innerHTML = `
                    <div class="room-icon">${hasAlarm ? 'ğŸ”¥' : 'ğŸ '}</div>
                    <div class="room-name">${room.room_name}</div>
                    <div class="room-status">
                        ${alarms.length} ä¸ªè®¾å¤‡
                        ${hasAlarm ? '<br>âš  æœ‰æŠ¥è­¦' : ''}
                    </div>
                `;

                gridContainer.appendChild(card);
            });
        }

        // æŒ‰æˆ¿é—´ç­›é€‰
        function filterByRoom(roomId) {
            const filtered = allAlarms.filter(a => a.room_id === roomId);
            displayAlarms(filtered);
            currentFilter = 'room';
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetails(alarmId) {
            window.location.href = `smoke-alarm.html?alarm=${alarmId}`;
        }

        // ç¡®è®¤æŠ¥è­¦
        async function acknowledgeAlarm(alarmId) {
            const acknowledgedBy = prompt('è¯·è¾“å…¥ç¡®è®¤äººå§“å:');
            if (!acknowledgedBy) return;

            const notes = prompt('è¯·è¾“å…¥å¤„ç†å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰:') || '';

            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/${alarmId}/acknowledge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        acknowledged_by: acknowledgedBy,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.status === 'success' || data.success) {
                    alert('æŠ¥è­¦å·²ç¡®è®¤');
                    await refreshData();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ç¡®è®¤æŠ¥è­¦å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // æµ‹è¯•è®¾å¤‡
        async function testDevice(alarmId) {
            if (!confirm(`ç¡®å®šè¦å¯åŠ¨ ${alarmId} çš„æµ‹è¯•æ¨¡å¼å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/${alarmId}/test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test_mode: true })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    alert('æµ‹è¯•æ¨¡å¼å·²å¯åŠ¨');
                    await refreshData();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('æµ‹è¯•è®¾å¤‡å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(text) {
            const toast = document.getElementById('notification-toast');
            document.getElementById('notification-text').textContent = text;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update-time').textContent = now.toLocaleTimeString('zh-CN');
        }

        // è·å–äº‹ä»¶å›¾æ ‡
        function getEventIcon(eventType) {
            const icons = {
                'ALARM_TRIGGERED': 'ğŸ”¥',
                'ALARM_CLEARED': 'âœ…',
                'LOW_BATTERY': 'ğŸ”‹',
                'TEST_STARTED': 'ğŸ”',
                'TEST_STOPPED': 'â¹',
                'SENSITIVITY_CHANGED': 'âš™ï¸'
            };
            return icons[eventType] || 'ğŸ“';
        }

        // è·å–äº‹ä»¶æ–‡æœ¬
        function getEventText(eventType) {
            const texts = {
                'ALARM_TRIGGERED': 'æŠ¥è­¦è§¦å‘',
                'ALARM_CLEARED': 'æŠ¥è­¦æ¸…é™¤',
                'LOW_BATTERY': 'ç”µæ± ç”µé‡ä½',
                'TEST_STARTED': 'æµ‹è¯•æ¨¡å¼å¯åŠ¨',
                'TEST_STOPPED': 'æµ‹è¯•æ¨¡å¼åœæ­¢',
                'SENSITIVITY_CHANGED': 'çµæ•åº¦å·²æ›´æ”¹'
            };
            return texts[eventType] || eventType;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = (now - date) / 1000; // ç§’

            if (diff < 60) {
                return 'åˆšåˆš';
            } else if (diff < 3600) {
                return `${Math.floor(diff / 60)} åˆ†é’Ÿå‰`;
            } else if (diff < 86400) {
                return `${Math.floor(diff / 3600)} å°æ—¶å‰`;
            } else {
                return date.toLocaleString('zh-CN');
            }
        }

        // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨å’Œæ–­å¼€WebSocket
        window.onbeforeunload = function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            if (socket) {
                socket.disconnect();
                console.log('WebSocket å·²æ–­å¼€');
            }
        };
    </script>
</body>
</html>
