<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç»´æŠ¤ç®¡ç† - NIS3351æ™ºæ…§å®¶å±…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        nav {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        nav a:hover {
            opacity: 0.8;
        }

        .content-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: scale(1.05);
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab:hover {
            color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .maintenance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .maintenance-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #007bff;
            transition: transform 0.3s;
        }

        .maintenance-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .maintenance-card.battery_replacement {
            border-left-color: #dc3545;
        }

        .maintenance-card.cleaning {
            border-left-color: #28a745;
        }

        .maintenance-card.test {
            border-left-color: #ffc107;
        }

        .maintenance-card.inspection {
            border-left-color: #6c757d;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .device-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .maintenance-type {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
            background: #007bff;
            color: white;
        }

        .maintenance-type.battery_replacement {
            background: #dc3545;
        }

        .maintenance-type.cleaning {
            background: #28a745;
        }

        .maintenance-type.test {
            background: #ffc107;
            color: #333;
        }

        .maintenance-type.inspection {
            background: #6c757d;
        }

        .card-detail {
            margin: 8px 0;
            color: #666;
        }

        .card-detail strong {
            color: #333;
        }

        .due-soon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .due-card {
            background: linear-gradient(135deg, #ffc107 0%, #ff6b6b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .due-card::before {
            content: 'âš ï¸';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 5em;
            opacity: 0.2;
        }

        .due-card-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .due-card-days {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .due-card-label {
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
        }

        .close {
            font-size: 2em;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .calendar-view {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ddd;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 25px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -34px;
            top: 5px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #007bff;
            border: 2px solid white;
        }

        .timeline-date {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .timeline-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <a href="index.html">é¦–é¡µ</a>
            <a href="smoke-alarm.html">çƒŸé›¾æŠ¥è­¦å™¨</a>
            <a href="alarm-dashboard.html">æŠ¥è­¦ä»ªè¡¨æ¿</a>
            <a href="alarm-statistics.html">ç»Ÿè®¡åˆ†æ</a>
            <a href="device-maintenance.html" style="font-weight: bold;">è®¾å¤‡ç»´æŠ¤</a>
            <a href="automation-rules.html">è‡ªåŠ¨åŒ–è§„åˆ™</a>
            <a href="room-management.html">æˆ¿é—´ç®¡ç†</a>
        </nav>

        <header>
            <h1>ğŸ”§ è®¾å¤‡ç»´æŠ¤ç®¡ç†</h1>
            <p>è·Ÿè¸ªè®¾å¤‡ç»´æŠ¤è®°å½•ï¼Œç¡®ä¿è®¾å¤‡æ­£å¸¸è¿è¡Œ</p>
        </header>

        <div class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-maintenance">0</div>
                    <div class="stat-label">æ€»ç»´æŠ¤è®°å½•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="due-count">0</div>
                    <div class="stat-label">å¾…ç»´æŠ¤è®¾å¤‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="this-month">0</div>
                    <div class="stat-label">æœ¬æœˆç»´æŠ¤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-cost">Â¥0</div>
                    <div class="stat-label">æ€»ç»´æŠ¤æˆæœ¬</div>
                </div>
            </div>
        </div>

        <div class="content-section">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('due')">å¾…ç»´æŠ¤è®¾å¤‡</button>
                <button class="tab" onclick="switchTab('history')">ç»´æŠ¤å†å²</button>
                <button class="tab" onclick="switchTab('timeline')">æ—¶é—´çº¿</button>
            </div>

            <!-- å¾…ç»´æŠ¤è®¾å¤‡æ ‡ç­¾é¡µ -->
            <div id="tab-due" class="tab-content active">
                <div class="section-header">
                    <h2 class="section-title">å¾…ç»´æŠ¤è®¾å¤‡</h2>
                    <button class="btn btn-warning" onclick="loadDueDevices()">ğŸ”„ åˆ·æ–°</button>
                </div>

                <div id="loading-due" class="loading">æ­£åœ¨åŠ è½½...</div>

                <div id="due-grid" class="due-soon-grid" style="display: none;"></div>

                <div id="empty-due" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">âœ…</div>
                    <h3>æ‰€æœ‰è®¾å¤‡çŠ¶æ€è‰¯å¥½</h3>
                    <p>æš‚æ— éœ€è¦ç»´æŠ¤çš„è®¾å¤‡</p>
                </div>
            </div>

            <!-- ç»´æŠ¤å†å²æ ‡ç­¾é¡µ -->
            <div id="tab-history" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">ç»´æŠ¤å†å²</h2>
                    <button class="btn btn-primary" onclick="openAddModal()">
                        + æ·»åŠ ç»´æŠ¤è®°å½•
                    </button>
                </div>

                <div class="filter-bar">
                    <label>ç­›é€‰:</label>
                    <select id="filter-device" onchange="loadMaintenanceRecords()">
                        <option value="">å…¨éƒ¨è®¾å¤‡</option>
                    </select>
                    <select id="filter-type" onchange="loadMaintenanceRecords()">
                        <option value="">å…¨éƒ¨ç±»å‹</option>
                        <option value="battery_replacement">ç”µæ± æ›´æ¢</option>
                        <option value="cleaning">æ¸…æ´</option>
                        <option value="test">æµ‹è¯•</option>
                        <option value="inspection">æ£€æŸ¥</option>
                    </select>
                </div>

                <div id="loading-history" class="loading">æ­£åœ¨åŠ è½½...</div>

                <div id="maintenance-grid" class="maintenance-grid" style="display: none;"></div>

                <div id="empty-history" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <h3>æš‚æ— ç»´æŠ¤è®°å½•</h3>
                    <p>ç‚¹å‡»"æ·»åŠ ç»´æŠ¤è®°å½•"æŒ‰é’®å¼€å§‹è®°å½•</p>
                </div>
            </div>

            <!-- æ—¶é—´çº¿æ ‡ç­¾é¡µ -->
            <div id="tab-timeline" class="tab-content">
                <div class="section-header">
                    <h2 class="section-title">ç»´æŠ¤æ—¶é—´çº¿</h2>
                </div>

                <div id="loading-timeline" class="loading">æ­£åœ¨åŠ è½½...</div>

                <div id="timeline-container" class="timeline" style="display: none;"></div>

                <div id="empty-timeline" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">ğŸ“…</div>
                    <h3>æš‚æ— ç»´æŠ¤è®°å½•</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ ç»´æŠ¤è®°å½•æ¨¡æ€æ¡† -->
    <div id="maintenance-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ ç»´æŠ¤è®°å½•</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>

            <form id="maintenance-form" onsubmit="submitMaintenance(event)">
                <div class="form-group">
                    <label for="alarm-id">è®¾å¤‡ *</label>
                    <select id="alarm-id" required>
                        <option value="">è¯·é€‰æ‹©è®¾å¤‡</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="maintenance-type">ç»´æŠ¤ç±»å‹ *</label>
                    <select id="maintenance-type" required>
                        <option value="battery_replacement">ç”µæ± æ›´æ¢</option>
                        <option value="cleaning">æ¸…æ´</option>
                        <option value="test">æµ‹è¯•</option>
                        <option value="inspection">æ£€æŸ¥</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="performed-by">ç»´æŠ¤äººå‘˜ *</label>
                    <input type="text" id="performed-by" required>
                </div>

                <div class="form-group">
                    <label for="maintenance-date">ç»´æŠ¤æ—¥æœŸ *</label>
                    <input type="datetime-local" id="maintenance-date" required>
                </div>

                <div class="form-group">
                    <label for="next-maintenance-date">ä¸‹æ¬¡ç»´æŠ¤æ—¥æœŸ</label>
                    <input type="datetime-local" id="next-maintenance-date">
                </div>

                <div class="form-group">
                    <label for="cost">è´¹ç”¨ (Â¥)</label>
                    <input type="number" id="cost" step="0.01" min="0" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="notes">å¤‡æ³¨</label>
                    <textarea id="notes" placeholder="è®°å½•ç»´æŠ¤è¯¦æƒ…..."></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success">ä¿å­˜è®°å½•</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000';
        let allMaintenanceRecords = [];
        let allAlarms = [];
        let currentTab = 'due';

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            await loadAlarms();
            await loadDueDevices();
            await loadMaintenanceRecords();
            setDefaultDateTime();
        };

        // åŠ è½½çƒŸé›¾æŠ¥è­¦å™¨åˆ—è¡¨
        async function loadAlarms() {
            try {
                const response = await fetch(`${API_BASE}/smoke_alarms`);
                allAlarms = await response.json();

                const selects = ['alarm-id', 'filter-device'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    allAlarms.forEach(alarm => {
                        const option = document.createElement('option');
                        option.value = alarm.alarm_id;
                        option.textContent = `${alarm.alarm_id} (${alarm.location || 'æœªçŸ¥ä½ç½®'})`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('åŠ è½½æŠ¥è­¦å™¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½å¾…ç»´æŠ¤è®¾å¤‡
        async function loadDueDevices() {
            try {
                document.getElementById('loading-due').style.display = 'block';
                document.getElementById('due-grid').style.display = 'none';
                document.getElementById('empty-due').style.display = 'none';

                const response = await fetch(`${API_BASE}/smoke_alarms/maintenance/due`);
                const data = await response.json();

                if (data.success && data.devices.length > 0) {
                    displayDueDevices(data.devices);
                    document.getElementById('due-count').textContent = data.devices.length;
                } else {
                    document.getElementById('empty-due').style.display = 'block';
                    document.getElementById('due-count').textContent = 0;
                }
            } catch (error) {
                console.error('åŠ è½½å¾…ç»´æŠ¤è®¾å¤‡å¤±è´¥:', error);
            } finally {
                document.getElementById('loading-due').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå¾…ç»´æŠ¤è®¾å¤‡
        function displayDueDevices(devices) {
            const grid = document.getElementById('due-grid');
            grid.innerHTML = '';
            grid.style.display = 'grid';

            devices.forEach(device => {
                const daysOverdue = device.days_overdue || 0;
                const card = document.createElement('div');
                card.className = 'due-card';
                card.innerHTML = `
                    <div class="due-card-title">${device.alarm_id}</div>
                    <div class="due-card-days">${Math.abs(daysOverdue)} å¤©</div>
                    <div class="due-card-label">${daysOverdue > 0 ? 'å·²é€¾æœŸ' : 'å³å°†åˆ°æœŸ'}</div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-sm btn-primary" onclick="quickMaintenance('${device.alarm_id}')">
                            å¿«é€Ÿç»´æŠ¤
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // åŠ è½½ç»´æŠ¤è®°å½•
        async function loadMaintenanceRecords() {
            try {
                document.getElementById('loading-history').style.display = 'block';
                document.getElementById('maintenance-grid').style.display = 'none';
                document.getElementById('empty-history').style.display = 'none';

                const response = await fetch(`${API_BASE}/smoke_alarms/maintenance`);
                const data = await response.json();

                if (data.success) {
                    allMaintenanceRecords = data.records || [];

                    // åº”ç”¨ç­›é€‰
                    const filterDevice = document.getElementById('filter-device').value;
                    const filterType = document.getElementById('filter-type').value;

                    let filtered = allMaintenanceRecords;

                    if (filterDevice) {
                        filtered = filtered.filter(r => r.alarm_id === filterDevice);
                    }

                    if (filterType) {
                        filtered = filtered.filter(r => r.maintenance_type === filterType);
                    }

                    displayMaintenanceRecords(filtered);
                    updateStats();
                    updateTimeline(allMaintenanceRecords);
                }
            } catch (error) {
                console.error('åŠ è½½ç»´æŠ¤è®°å½•å¤±è´¥:', error);
            } finally {
                document.getElementById('loading-history').style.display = 'none';
                document.getElementById('loading-timeline').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºç»´æŠ¤è®°å½•
        function displayMaintenanceRecords(records) {
            const grid = document.getElementById('maintenance-grid');
            grid.innerHTML = '';

            if (records.length === 0) {
                document.getElementById('empty-history').style.display = 'block';
                return;
            }

            grid.style.display = 'grid';

            records.forEach(record => {
                const card = document.createElement('div');
                card.className = `maintenance-card ${record.maintenance_type}`;
                card.innerHTML = `
                    <div class="card-header">
                        <div class="device-name">${record.alarm_id}</div>
                        <div class="maintenance-type ${record.maintenance_type}">
                            ${getMaintenanceTypeText(record.maintenance_type)}
                        </div>
                    </div>
                    <div class="card-detail">
                        <strong>ç»´æŠ¤äººå‘˜:</strong> ${record.performed_by}
                    </div>
                    <div class="card-detail">
                        <strong>ç»´æŠ¤æ—¥æœŸ:</strong> ${formatDateTime(record.maintenance_date)}
                    </div>
                    ${record.next_maintenance_date ? `
                        <div class="card-detail">
                            <strong>ä¸‹æ¬¡ç»´æŠ¤:</strong> ${formatDateTime(record.next_maintenance_date)}
                        </div>
                    ` : ''}
                    ${record.cost ? `
                        <div class="card-detail">
                            <strong>è´¹ç”¨:</strong> Â¥${parseFloat(record.cost).toFixed(2)}
                        </div>
                    ` : ''}
                    ${record.notes ? `
                        <div class="card-detail" style="margin-top: 10px;">
                            <strong>å¤‡æ³¨:</strong> ${record.notes}
                        </div>
                    ` : ''}
                `;
                grid.appendChild(card);
            });
        }

        // æ›´æ–°æ—¶é—´çº¿
        function updateTimeline(records) {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            if (records.length === 0) {
                document.getElementById('empty-timeline').style.display = 'block';
                return;
            }

            container.style.display = 'block';

            // æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
            const sorted = [...records].sort((a, b) =>
                new Date(b.maintenance_date) - new Date(a.maintenance_date)
            );

            sorted.forEach(record => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-date">${formatDate(record.maintenance_date)}</div>
                    <div class="timeline-content">
                        <strong>${record.alarm_id}</strong> - ${getMaintenanceTypeText(record.maintenance_type)}
                        <br>
                        <small>ç»´æŠ¤äººå‘˜: ${record.performed_by}</small>
                        ${record.notes ? `<br><small>${record.notes}</small>` : ''}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const total = allMaintenanceRecords.length;
            document.getElementById('total-maintenance').textContent = total;

            // è®¡ç®—æœ¬æœˆç»´æŠ¤æ¬¡æ•°
            const now = new Date();
            const thisMonth = allMaintenanceRecords.filter(r => {
                const date = new Date(r.maintenance_date);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('this-month').textContent = thisMonth;

            // è®¡ç®—æ€»æˆæœ¬
            const totalCost = allMaintenanceRecords.reduce((sum, r) =>
                sum + (parseFloat(r.cost) || 0), 0
            );
            document.getElementById('total-cost').textContent = `Â¥${totalCost.toFixed(2)}`;
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            currentTab = tab;

            // æ›´æ–°æ ‡ç­¾æŒ‰é’®
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            // åŠ è½½ç›¸åº”æ•°æ®
            if (tab === 'due') {
                loadDueDevices();
            } else if (tab === 'timeline' && allMaintenanceRecords.length > 0) {
                updateTimeline(allMaintenanceRecords);
            }
        }

        // æ‰“å¼€æ·»åŠ æ¨¡æ€æ¡†
        function openAddModal() {
            document.getElementById('maintenance-form').reset();
            setDefaultDateTime();
            document.getElementById('maintenance-modal').style.display = 'block';
        }

        // å¿«é€Ÿç»´æŠ¤
        function quickMaintenance(alarmId) {
            document.getElementById('alarm-id').value = alarmId;
            openAddModal();
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('maintenance-modal').style.display = 'none';
        }

        // æäº¤ç»´æŠ¤è®°å½•
        async function submitMaintenance(event) {
            event.preventDefault();

            const formData = {
                alarm_id: document.getElementById('alarm-id').value,
                maintenance_type: document.getElementById('maintenance-type').value,
                performed_by: document.getElementById('performed-by').value,
                maintenance_date: document.getElementById('maintenance-date').value,
                next_maintenance_date: document.getElementById('next-maintenance-date').value || null,
                cost: parseFloat(document.getElementById('cost').value) || null,
                notes: document.getElementById('notes').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/smoke_alarms/${formData.alarm_id}/maintenance`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('ç»´æŠ¤è®°å½•æ·»åŠ æˆåŠŸ');
                    closeModal();
                    await loadMaintenanceRecords();
                    await loadDueDevices();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('æäº¤ç»´æŠ¤è®°å½•å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        }

        // è®¾ç½®é»˜è®¤æ—¥æœŸæ—¶é—´ä¸ºå½“å‰æ—¶é—´
        function setDefaultDateTime() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = new Date(now - offset).toISOString().slice(0, 16);
            document.getElementById('maintenance-date').value = localISOTime;
        }

        // è·å–ç»´æŠ¤ç±»å‹æ–‡æœ¬
        function getMaintenanceTypeText(type) {
            const types = {
                'battery_replacement': 'ğŸ”‹ ç”µæ± æ›´æ¢',
                'cleaning': 'ğŸ§¹ æ¸…æ´',
                'test': 'ğŸ” æµ‹è¯•',
                'inspection': 'ğŸ“‹ æ£€æŸ¥'
            };
            return types[type] || type;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('maintenance-modal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
